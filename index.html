<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BK-AI Chat</title>
<style>
  body { margin:0; font-family:'Vazir','Segoe UI',sans-serif; background:#f9fafb; }
  .chat-toggle-btn { position:fixed; bottom:20px; right:20px; width:70px; height:70px; background-color:#8b5cf6; border:none; border-radius:50%; cursor:pointer; z-index:1001; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 20px rgba(139,92,246,0.4); }
  .chat-toggle-btn:hover { background-color:#22c55e; }
  .chat-toggle-btn img { width:40px; height:40px; position:absolute; transition: transform 0.3s ease; }
  #botIconNormal { filter: brightness(100%) grayscale(100%); }
  #botIconActive { display:none; filter: brightness(0%) grayscale(100%) invert(100%); }
  .chat-toggle-btn.active #botIconNormal { display:none; }
  .chat-toggle-btn.active #botIconActive { display:block; }
  .pulse-circle { position:absolute; border-radius:50%; background-color:rgba(34,197,94,0.3); z-index:-1; animation:pulse 2s infinite ease-in-out; }
  .circle1 { width:80px; height:80px; }
  .circle2 { width:100px; height:100px; animation-delay:1s; }
  @keyframes pulse {0%{transform:scale(0.9);opacity:0.7;}50%{transform:scale(1.1);opacity:0.3;}100%{transform:scale(0.9);opacity:0.7;}}
  #chatContainer { display:none; position:fixed; bottom:90px; right:20px; width:400px; height:600px; background:white; border-radius:20px; box-shadow:0 0 25px rgba(0,0,0,0.15); overflow:hidden; z-index:1000; flex-direction:column; transition: all 0.4s ease;}
  @media (max-width:768px){ #chatContainer { width:100%; height:100%; bottom:0; right:0; border-radius:0; } }
  .chat-header { background:linear-gradient(90deg,#3b82f6,#8b5cf6); color:white; padding:1rem; display:flex; justify-content:space-between; align-items:center; font-weight:600; font-size:1rem; box-shadow:0 4px 10px rgba(0,0,0,0.15); position:relative; }
  .chat-header .chat-title { display:flex; align-items:center; gap:10px; }
  .chat-header img { width:30px; height:30px; border-radius:50%; background:white; padding:4px; }
  .header-btns { display:flex; align-items:center; gap:10px; }
  .header-btn { background:rgba(255,255,255,0.15); border:none; color:white; font-size:1.2rem; border-radius:50%; width:36px; height:36px; cursor:pointer; transition:all 0.3s ease; position:relative; overflow:visible; }
  .header-btn:hover { background:rgba(255,255,255,0.35); transform:scale(1.15); }
  .header-btn .tooltip { position:absolute; top:50%; right:120%; transform:translateY(-50%); background:rgba(17,24,39,0.9); color:white; padding:5px 10px; border-radius:6px; font-size:0.8rem; white-space:nowrap; opacity:0; transition:all 0.3s ease; pointer-events:none; }
  .header-btn:hover .tooltip { right:140%; opacity:1; }
  .chat-box { flex:1; overflow-y:auto; padding:1rem; background:#f9fafb; }
  .message { margin-bottom:1rem; padding:0.6rem 0.8rem; border-radius:12px; max-width:80%; line-height:1.6; white-space:pre-wrap; position:relative; }
  .user { background:#dbeafe; margin-left:auto; }
  .assistant { background:#f3f4f6; margin-right:auto; }
  .msg-time { display:block; text-align:right; font-size:0.75rem; color:#9ca3af; margin-top:4px; }
  .user .msg-time { text-align:left; }
  .input-area { display:flex; padding:0.8rem; gap:0.5rem; border-top:1px solid #ddd; background:#fff; }
  input[type="text"] { flex:1; padding:0.6rem; font-size:1rem; border-radius:8px; border:1px solid #ccc; }
  button.send-btn { background:#3b82f6; color:white; border:none; border-radius:8px; padding:0.6rem 1rem; font-size:1rem; cursor:pointer; transition:all 0.2s ease; }
  button.send-btn:hover { background:#2563eb; }
  .typing { font-style:italic; color:#6b7280; padding:0.5rem 1rem; }
</style>
</head>
<body>

<button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChat()">
  <div class="pulse-circle circle1"></div>
  <div class="pulse-circle circle2"></div>
  <img id="botIconNormal" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" />
  <img id="botIconActive" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" />
</button>

<div id="chatContainer">
  <div class="chat-header">
    <div class="chat-title">
      <img src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" />
      <span>BK Assistant</span>
    </div>
    <div class="header-btns">
      <button class="header-btn" onclick="callCreator()">📞<span class="tooltip">تماس با سازنده</span></button>
      <button class="header-btn" onclick="closeChat()">✕</button>
    </div>
  </div>
  <div class="chat-box" id="chatBox"></div>
  <div class="typing" id="typingIndicator" style="display:none;">در حال نوشتن...</div>
  <div class="input-area">
    <input type="text" id="userInput" placeholder="...پیام خود را بنویسید" />
    <button class="send-btn" onclick="sendMessage()">ارسال</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
<script>
const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');
const typingIndicator = document.getElementById('typingIndicator');
const sendBtn = document.querySelector('.send-btn');
const chatContainer = document.getElementById('chatContainer');
const chatToggleBtn = document.getElementById('chatToggleBtn');

let messages = [];
let stopTyping = false;
let fuseIndex = null;
let jsonData = null;

// پاسخ‌های عادی
const casualReplies = [
  {patterns:[/سلام/i,/hi/i], reply:"سلام! چطور می‌تونم کمکت کنم؟"},
  {patterns:[/خداحافظ/i,/bye/i], reply:"خداحافظ! روزت عالی باشه!"},
  {patterns:[/چه کار می‌کنی/i], reply:"من آماده‌ام که اطلاعات سایت رو بهت بدم!"},
  {patterns:[/تشکر/i,/ممنون/i], reply:"خواهش می‌کنم 😊"}
];

// --- توابع چت ---
function isMobile() { return window.innerWidth <= 768; }
function toggleChat(){ chatContainer.style.display==='flex'?closeChat():openChat(); }
function openChat(){ chatContainer.style.display='flex'; chatToggleBtn.classList.add('active'); if(isMobile()){ chatToggleBtn.style.visibility='hidden'; chatToggleBtn.style.opacity='0'; } }
function closeChat(){ chatContainer.style.display='none'; chatToggleBtn.classList.remove('active'); if(isMobile()){ chatToggleBtn.style.visibility='visible'; chatToggleBtn.style.opacity='1'; } }

const renderMessages = ()=>{
  chatBox.innerHTML="";
  messages.forEach(msg=>{
    const div=document.createElement("div");
    div.className="message "+(msg.role==="user"?"user":"assistant");
    div.innerHTML=`${msg.content}<span class="msg-time">${msg.time||""}</span>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
};

async function loadJson() {
  if(fuseIndex) return;
  const res=await fetch("https://raw.githubusercontent.com/mahdiklidari190/AI-PRO/main/data.json");
  jsonData=await res.json();
  const flat=[];
  (jsonData.pages||[]).forEach(p=>{
    flat.push({title:p.title||"", summary:p.summary||p.content_snippet||"", url:p.url||"", raw:p});
    if(p.items) p.items.forEach(it=>flat.push({title:it.title||"", summary:"", url:it.url||"", raw:p}));
    if(p.products) p.products.forEach(pr=>flat.push({title:pr.title||"", summary:"", url:pr.url||"", raw:p}));
  });
  fuseIndex=new Fuse(flat,{keys:["title","summary"],threshold:0.4});
}

async function answerFromJson(query){
  await loadJson();
  const results=fuseIndex.search(query,{limit:5});
  if(!results.length) return "متأسفانه چنین چیزی توی داده‌ها پیدا نکردم.";
  const parts=results.map(r=>{
    const item=r.item;
    const title=item.title||"بدون عنوان";
    const url=item.url||"https://www.nspvco.com";
    const summary=item.summary||"";
    return `عنوان: ${title}\nخلاصه: ${summary}\nلینک: ${url}`;
  });
  return parts.join("\n\n---\n\n");
}

function checkCasualReplies(msg){
  for(const c of casualReplies){
    if(c.patterns.some(p=>p.test(msg))) return c.reply;
  }
  return null;
}

async function sendMessage(){
  const content=userInput.value.trim();
  if(!content) return;
  const timeStr=new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
  messages.push({role:"user", content, time:timeStr});
  renderMessages();
  userInput.value="";
  typingIndicator.style.display="block";
  sendBtn.textContent="توقف";
  sendBtn.onclick=()=>{stopTyping=true;};
  stopTyping=false;

  let reply = checkCasualReplies(content);
  if(!reply){
    reply = await answerFromJson(content);
  }

  const replyTime=new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
  messages.push({role:"assistant", content:"", time:replyTime});
  renderMessages();

  let i=0;
  const interval=setInterval(()=>{
    if(stopTyping || i>=reply.length){
      clearInterval(interval);
      sendBtn.textContent="ارسال";
      sendBtn.onclick=sendMessage;
      return;
    }
    messages[messages.length-1].content+=reply[i];
    renderMessages();
    i++;
  },30);

}

function callCreator(){ window.location.href="tel:09211243320"; }

userInput.addEventListener("keydown", function(e){
  if(e.key==="Enter"){ e.preventDefault(); sendMessage(); }
});
</script>
</body>
</html>
