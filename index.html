<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BK-AI Chat Multilingual</title>
  <style>
    /* استایل‌ها همانند قبل هستند — برای اختصار حذف شده‌اند */
  </style>
</head>
<body>

<!-- دکمه چت و پنجره چت -->
<button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChat()">
  <div class="pulse-circle circle1"></div>
  <div class="pulse-circle circle2"></div>
  <img id="botIconNormal" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="ربات سفید"/>
  <img id="botIconActive" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="ربات فعال"/>
</button>

<div id="chatContainer">
  <div class="chat-header">
    <div class="chat-title"><img src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="bot"/><span>BK Assistant</span></div>
    <div class="header-btns">
      <button class="header-btn" onclick="callCreator()">📞<span class="tooltip">تماس با سازنده</span></button>
      <button class="header-btn" onclick="closeChat()">✕</button>
    </div>
  </div>
  <div class="chat-box" id="chatBox"></div>
  <div class="typing" id="typingIndicator">در حال نوشتن...</div>
  <div class="input-area">
    <input type="text" id="userInput" placeholder="...پیام خود را بنویسید"/>
    <button class="send-btn" onclick="sendMessage()">ارسال</button>
  </div>
</div>

<script>
const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');
const typingIndicator = document.getElementById('typingIndicator');
const sendBtn = document.querySelector('.send-btn');
const chatContainer = document.getElementById('chatContainer');
const chatToggleBtn = document.getElementById('chatToggleBtn');

let messages = [];
let typingInterval = null;
let stopTyping = false;
let jsonData = null;

// بارگذاری JSON
async function loadJSON() {
  try {
    const res = await fetch('https://raw.githubusercontent.com/mahdiklidari190/AI-PRO/main/data.json');
    jsonData = await res.json();
  } catch(e) {
    console.error("خطا در بارگذاری JSON:", e);
    jsonData = null;
  }
}
loadJSON();

// تشخیص زبان
function detectLanguage(text){
  const persian = /[\u0600-\u06FF]/;
  const arabic = /[\u0750-\u077F\u08A0-\u08FF]/;
  if(persian.test(text)) return 'fa';
  if(arabic.test(text)) return 'ar';
  return 'en';
}

function isMobile() { return window.innerWidth <= 768; }

function toggleChat() {
  if(chatContainer.style.display==='flex') closeChat();
  else openChat();
}
function openChat() {
  chatContainer.style.display='flex';
  chatToggleBtn.classList.add('active');
  if(isMobile()){chatToggleBtn.style.visibility='hidden';chatToggleBtn.style.opacity='0';}
}
function closeChat() {
  chatContainer.style.display='none';
  chatToggleBtn.classList.remove('active');
  if(isMobile()){chatToggleBtn.style.visibility='visible';chatToggleBtn.style.opacity='1';}
}

function renderMessages() {
  chatBox.innerHTML='';
  messages.forEach(msg=>{
    const div=document.createElement("div");
    div.className="message "+(msg.role==="user"?"user":"assistant");
    div.innerHTML=`${msg.content}<span class="msg-time">${msg.time||""}</span>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
}

const stopMessage=()=>{stopTyping=true;};
function callCreator(){window.location.href="tel:09211243320";}
userInput.addEventListener("keydown",function(e){if(e.key==="Enter"){e.preventDefault();sendMessage();}});

// جستجو در JSON
function searchJSON(query, lang){
  if(!jsonData) return null;
  query = query.toLowerCase();
  if(jsonData.company.name.toLowerCase().includes(query)){
    let text = `نام شرکت: ${jsonData.company.name}\nتلفن‌ها: ${jsonData.company.phones.join(', ')}\nآدرس دفتر: ${jsonData.company.addresses.office}\nساعت کاری: ${jsonData.company.working_hours}`;
    if(lang!=='fa') text = translateToEnglish(text);
    return text;
  }
  for(const page of jsonData.pages){
    if(page.title.toLowerCase().includes(query) || (page.summary && page.summary.toLowerCase().includes(query))){
      let text = `${page.title}\n${page.summary||''}`;
      if(page.items) text+='\nموارد: '+page.items.map(i=>i.title).join(', ');
      if(lang!=='fa') text=translateToEnglish(text);
      return text;
    }
    if(page.products){
      let found = page.products.find(p=>p.title.toLowerCase().includes(query));
      if(found){
        let text = `محصول: ${found.title}\nلینک: ${found.url}`;
        if(lang!=='fa') text=translateToEnglish(text);
        return text;
      }
    }
  }
  return null;
}

function translateToEnglish(text){
  const mapping = {
    "نام شرکت": "Company Name",
    "تلفن‌ها": "Phones",
    "آدرس دفتر": "Office Address",
    "ساعت کاری": "Working Hours",
    "موارد": "Items",
    "محصول": "Product"
  };
  for(const key in mapping) text = text.replaceAll(key, mapping[key]);
  return text;
}

// ارسال پیام
async function sendMessage(){
  const content = userInput.value.trim();
  if(!content) return;
  const timeStr = new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
  messages.push({role:"user",content,time:timeStr});
  renderMessages();
  userInput.value="";
  typingIndicator.style.display='block';
  sendBtn.textContent='توقف';
  sendBtn.onclick=()=>{stopTyping=true;};
  stopTyping=false;

  const lang = detectLanguage(content);
  const jsonReply = searchJSON(content, lang);
  if(jsonReply){ await simulateTyping(jsonReply); return; }

  const tokens = [
    "sk-O04WeiK7sWKfKQbzpFj9ilNFvOiS7VpgZJNbpXHaVEqGAYVG",
    "sk-ZLf92w8qWXqhkA8gf2tmpFasGzb9d9Et5ymcdM2RIr8PAqDm"
  ];

  for (let token of tokens) {
    try {
      const apiResponse = await fetch("https://api.gapgpt.app/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          model: "gpt-4o",
          messages: messages.map(({role,content}) => ({role,content})),
          max_tokens: 400
        })
      });

      const data = await apiResponse.json();
      if (data.choices && data.choices[0] && data.choices[0].message) {
        let reply = data.choices[0].message.content;
        if (/(کد|برنامه|تبدیل|محاسبه|run|code)/i.test(content)) {
          reply = lang === 'fa' ? 'متاسفم، من محدود هستم و نمی‌توانم این کار را انجام دهم.' : 'Sorry, I am limited and cannot do that.';
        }
        await simulateTyping(reply);
        return;
      }
    } catch (err) {
      console.warn(`توکن ${token} با خطا مواجه شد`, err);
    }
  }

  await simulateTyping(lang === 'fa' ? 'مشکلی پیش آمد، پاسخ دریافت نشد.' : 'An error occurred, no response received.');
}

// تایپ تدریجی
async function simulateTyping(text){
  messages.push({role:"assistant",content:"",time:new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})});
  renderMessages();
  let i=0;
  return new Promise(resolve=>{
    typingInterval=setInterval(()=>{
      if(stopTyping || i
