<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BK-AI Chat</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb;
      direction: rtl;
    }

    #chatContainer {
      display: flex;
      flex-direction: column;
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 400px;
      height: 600px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      overflow: hidden;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      #chatContainer {
        width: 100%;
        height: 100%;
        bottom: 0;
        right: 0;
        border-radius: 0;
      }
    }

    .chat-header {
      background: #0ea5e9;
      color: white;
      padding: 0.8rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header button {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.2rem 0.6rem;
      cursor: pointer;
    }

    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message-wrapper {
      display: flex;
      flex-direction: column;
      max-width: 80%;
    }

    .message-wrapper.user {
      align-self: flex-end;
      text-align: right;
    }

    .message-wrapper.assistant {
      align-self: flex-start;
      text-align: left;
    }

    .message {
      padding: 0.6rem 0.8rem;
      border-radius: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
      font-size: 1rem;
    }

    .message-wrapper.user .message {
      background: #dbeafe;
      border-bottom-right-radius: 0;
    }

    .message-wrapper.assistant .message {
      background: #f3f4f6;
      border-bottom-left-radius: 0;
    }

    .message-info {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 3px;
      display: flex;
      justify-content: space-between;
      font-style: italic;
      direction: ltr; /* ساعت و مکان انگلیسی باشه */
      gap: 5px;
    }

    .message-info.user {
      justify-content: flex-end;
    }

    .message-info.assistant {
      justify-content: flex-start;
    }

    .location {
      color: #22c55e; /* سبز */
      font-weight: 600;
    }

    .typing {
      font-style: italic;
      color: #6b7280;
      padding: 0.5rem 1rem;
    }

    /* ورودی و دکمه ارسال */
    .input-area {
      display: flex;
      padding: 0.8rem;
      gap: 0.5rem;
      border-top: 1px solid #ddd;
      background: #fff;
    }

    input[type="text"] {
      flex: 1;
      padding: 0.6rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button.send-btn {
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }

    button.send-btn:hover {
      background: #0284c7;
    }
  </style>
</head>
<body>

  <div id="chatContainer">
    <div class="chat-header">
      BK-AI Chat
      <button onclick="closeChat()">✖</button>
    </div>
    <div class="chat-box" id="chatBox"></div>
    <div class="typing" id="typingIndicator" style="display:none;">در حال نوشتن...</div>
    <div class="input-area">
      <input type="text" id="userInput" placeholder="...پیام خود را بنویسید" autocomplete="off" />
      <button class="send-btn" onclick="sendMessage()">ارسال</button>
    </div>
  </div>

<script>
  const chatBox = document.getElementById('chatBox');
  const userInput = document.getElementById('userInput');
  const typingIndicator = document.getElementById('typingIndicator');
  const sendBtn = document.querySelector('.send-btn');
  const chatContainer = document.getElementById('chatContainer');

  let messages = [];
  let typingInterval = null;
  let stopTyping = false;
  let userLocation = '';

  // گرفتن موقعیت مکانی کاربر
  function getUserLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        resolve('');
        return;
      }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        try {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          // با استفاده از یک API رایگان مکان رو تبدیل به اسم شهر کنیم
          // اینجا از api.open-meteo.com استفاده می کنیم که نیازی به کلید API نداره:
          const res = await fetch(`https://geocode.maps.co/reverse?lat=${lat}&lon=${lon}`);
          if (!res.ok) {
            resolve('');
            return;
          }
          const data = await res.json();
          // اسم شهر یا منطقه
          if (data && data.address) {
            if (data.address.city) {
              resolve(data.address.city);
            } else if(data.address.town) {
              resolve(data.address.town);
            } else if(data.address.village) {
              resolve(data.address.village);
            } else if(data.address.county) {
              resolve(data.address.county);
            } else {
              resolve('');
            }
          } else {
            resolve('');
          }
        } catch {
          resolve('');
        }
      }, () => {
        resolve('');
      }, {timeout: 7000});
    });
  }

  function formatDate(date) {
    // فرمت ساده برای تاریخ و ساعت (مثلا: 14:35 09/10/2025)
    const h = date.getHours().toString().padStart(2,'0');
    const m = date.getMinutes().toString().padStart(2,'0');
    const d = date.getDate().toString().padStart(2,'0');
    const mon = (date.getMonth()+1).toString().padStart(2,'0');
    const y = date.getFullYear();
    return `${h}:${m} ${d}/${mon}/${y}`;
  }

  function renderMessages() {
    chatBox.innerHTML = "";
    messages.forEach(msg => {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper ' + (msg.role === 'user' ? 'user' : 'assistant');

      const msgDiv = document.createElement('div');
      msgDiv.className = 'message';
      msgDiv.textContent = msg.content;

      const infoDiv = document.createElement('div');
      infoDiv.className = 'message-info ' + (msg.role === 'user' ? 'user' : 'assistant');

      // تاریخ و ساعت
      const timeSpan = document.createElement('span');
      timeSpan.textContent = formatDate(new Date(msg.timestamp));
      infoDiv.appendChild(timeSpan);

      // موقعیت مکانی فقط برای پیام کاربر
      if(msg.role === 'user' && msg.location) {
        const locSpan = document.createElement('span');
        locSpan.className = 'location';
        locSpan.textContent = msg.location;
        infoDiv.appendChild(locSpan);
      }

      wrapper.appendChild(msgDiv);
      wrapper.appendChild(infoDiv);

      chatBox.appendChild(wrapper);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function sendMessage() {
    const content = userInput.value.trim();
    if (!content) return;

    // اگر موقعیت مکانی هنوز نگرفته ایم بگیرش
    if(!userLocation) {
      userLocation = await getUserLocation();
    }

    // پیام کاربر همراه با زمان و موقعیت مکانی
    messages.push({
      role: 'user',
      content,
      timestamp: new Date(),
      location: userLocation || ''
    });
    renderMessages();
    userInput.value = "";

    typingIndicator.style.display = "block";
    sendBtn.textContent = "توقف";
    sendBtn.onclick = stopMessage;
    stopTyping = false;

    try {
      const response = await fetch("https://api.gapgpt.app/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer sk-S5rOGsclcKTN9vdMMsx3fZ1bYXALVqBV0z8WebUcX668zia4"
        },
        body: JSON.stringify({
          model: "gpt-4o",
          messages: messages
        })
      });

      const data = await response.json();
      typingIndicator.style.display = "none";

      const reply = data.choices[0].message.content;
      messages.push({
        role: 'assistant',
        content: '',
        timestamp: new Date()
      });
      renderMessages();

      let i = 0;
      typingInterval = setInterval(() => {
        if(stopTyping || i >= reply.length) {
          clearInterval(typingInterval);
          sendBtn.textContent = "ارسال";
          sendBtn.onclick = sendMessage;
          return;
        }
        messages[messages.length - 1].content += reply[i];
        renderMessages();
        i++;
      }, 30);
    } catch (error) {
      console.error("خطا در دریافت پاسخ:", error);
      typingIndicator.style.display = "none";
      sendBtn.textContent = "ارسال";
      sendBtn.onclick = sendMessage;
    }
  }

  function stopMessage() {
    stopTyping = true;
  }

  userInput.addEventListener("keydown", function(e) {
    if(e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });

  function closeChat() {
    chatContainer.style.display = 'none';
  }
</script>
</body>
</html>
