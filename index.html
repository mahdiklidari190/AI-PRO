<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BK-AI Chat Multilingual</title>
<style>
body{margin:0;font-family:'Vazir','Segoe UI',sans-serif;background:#f9fafb;}
.chat-toggle-btn{position:fixed;bottom:20px;right:20px;width:70px;height:70px;background-color:#8b5cf6;border:none;border-radius:50%;cursor:pointer;z-index:1001;display:flex;align-items:center;justify-content:center;overflow:visible;box-shadow:0 8px 20px rgba(139,92,246,0.4);transition:all 0.4s ease;}
.chat-toggle-btn:hover{background-color:#22c55e;}
.chat-toggle-btn img{width:40px;height:40px;position:absolute;transition:transform 0.3s ease;}
#botIconNormal{filter:brightness(100%) grayscale(100%);}
#botIconActive{display:none;filter:brightness(0%) grayscale(100%) invert(100%);}
.chat-toggle-btn:hover #botIconNormal{transform:scale(1.2); filter:brightness(0%) grayscale(100%) invert(100%);}
.chat-toggle-btn.active{background-color:#22c55e;}
.chat-toggle-btn.active #botIconNormal{display:none;}
.chat-toggle-btn.active #botIconActive{display:block;}
.pulse-circle{position:absolute;border-radius:50%;background-color:rgba(34,197,94,0.3);z-index:-1;animation:pulse 2s infinite ease-in-out;}
.circle1{width:80px;height:80px;}
.circle2{width:100px;height:100px;animation-delay:1s;}
@keyframes pulse{0%{transform:scale(0.9);opacity:0.7;}50%{transform:scale(1.1);opacity:0.3;}100%{transform:scale(0.9);opacity:0.7;}}
#chatContainer{display:none;position:fixed;bottom:90px;right:20px;width:400px;height:600px;background:white;border-radius:20px;box-shadow:0 0 25px rgba(0,0,0,0.15);overflow:hidden;z-index:1000;flex-direction:column;transition:all 0.4s ease,opacity 0.4s ease;opacity:0;}
#chatContainer.show{opacity:1;}
@media(max-width:768px){#chatContainer{width:100%;height:100%;bottom:0;right:0;border-radius:0;}}
.chat-header{background:linear-gradient(90deg,#3b82f6,#8b5cf6);color:white;padding:1rem;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:1rem;box-shadow:0 4px 10px rgba(0,0,0,0.15);position:relative;}
.chat-header .chat-title{display:flex;align-items:center;gap:10px;}
.chat-header img{width:30px;height:30px;border-radius:50%;background:white;padding:4px;}
.header-btns{display:flex;align-items:center;gap:10px;}
.header-btn{background:rgba(255,255,255,0.15);border:none;color:white;font-size:1.2rem;border-radius:50%;width:36px;height:36px;cursor:pointer;transition:all 0.3s ease;position:relative;overflow:visible;}
.header-btn:hover{background:rgba(255,255,255,0.35);transform:scale(1.15);}
.header-btn .tooltip{position:absolute;top:50%;right:120%;transform:translateY(-50%);background:rgba(17,24,39,0.9);color:white;padding:5px 10px;border-radius:6px;font-size:0.8rem;white-space:nowrap;opacity:0;transition:all 0.3s ease;pointer-events:none;}
.header-btn:hover .tooltip{right:140%;opacity:1;}
.chat-box{flex:1;overflow-y:auto;padding:1rem;padding-bottom:70px;background:#f9fafb;}
.message{margin-bottom:1rem;padding:0.6rem 0.8rem;border-radius:12px;max-width:80%;line-height:1.6;white-space:pre-wrap;position:relative;}
.user{background:#dbeafe;margin-left:auto;}
.assistant{background:#f3f4f6;margin-right:auto;}
.msg-time{display:block;text-align:right;font-size:0.75rem;color:#9ca3af;margin-top:4px;}
.user .msg-time{text-align:left;}
.input-area{display:flex;padding:0.8rem;gap:0.5rem;border-top:1px solid #ddd;background:#fff;position:relative;z-index:1;}
input[type="text"]{flex:1;padding:0.6rem;font-size:1rem;border-radius:8px;border:1px solid #ccc;}
button.send-btn{background:#3b82f6;color:white;border:none;border-radius:8px;padding:0.6rem 1rem;font-size:1rem;cursor:pointer;transition:all 0.2s ease;}
button.send-btn:hover{background:#2563eb;}
button.send-btn:disabled{background:#a5b4fc;cursor:not-allowed;}
.typing{position:absolute;bottom:70px;left:1rem;right:1rem;font-style:italic;color:#6b7280;display:none;}
</style>
</head>
<body>

<!-- ÿØ⁄©ŸÖŸá Ÿà ŸæŸÜÿ¨ÿ±Ÿá ⁄Üÿ™ -->
<button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChat()">
  <div class="pulse-circle circle1"></div>
  <div class="pulse-circle circle2"></div>
  <img id="botIconNormal" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="ÿ±ÿ®ÿßÿ™ ÿ≥ŸÅ€åÿØ"/>
  <img id="botIconActive" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="ÿ±ÿ®ÿßÿ™ ŸÅÿπÿßŸÑ"/>
</button>

<div id="chatContainer">
  <div class="chat-header">
    <div class="chat-title"><img src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="bot"/><span>BK Assistant</span></div>
    <div class="header-btns">
      <button class="header-btn" onclick="callCreator()">üìû<span class="tooltip">ÿ™ŸÖÿßÿ≥ ÿ®ÿß ÿ≥ÿßÿ≤ŸÜÿØŸá</span></button>
      <button class="header-btn" onclick="closeChat()">‚úï</button>
    </div>
  </div>
  <div class="chat-box" id="chatBox"></div>
  <div class="typing" id="typingIndicator">ÿØÿ± ÿ≠ÿßŸÑ ŸÜŸàÿ¥ÿ™ŸÜ...</div>
  <div class="input-area">
    <input type="text" id="userInput" placeholder="...Ÿæ€åÿßŸÖ ÿÆŸàÿØ ÿ±ÿß ÿ®ŸÜŸà€åÿ≥€åÿØ"/>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">ÿßÿ±ÿ≥ÿßŸÑ</button>
  </div>
</div>

<script>
const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');
const typingIndicator = document.getElementById('typingIndicator');
const sendBtn = document.getElementById('sendBtn');
const chatContainer = document.getElementById('chatContainer');
const chatToggleBtn = document.getElementById('chatToggleBtn');

let messages=[];
let typingInterval=null;
let stopTyping=false;
let jsonData=null;
const GAP_TOKEN="sk-T15TGdP9wukEdUzMiP6dJRIYI0oQ1mbx0jdtS7SDAmuZor4G";
let isTyping=false;
const RESTRICT_LIMIT=3;
const BLOCK_HOURS=5;

async function loadJSON(){
  try{
    const res=await fetch('https://raw.githubusercontent.com/mahdiklidari190/AI-PRO/main/data.json');
    jsonData=await res.json();
  }catch(e){console.error("ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å JSON:",e);jsonData=null;}
}
loadJSON();

function detectLanguage(text){
  const persian=/[\u0600-\u06FF]/;
  const arabic=/[\u0750-\u077F\u08A0-\u08FF]/;
  if(persian.test(text)) return 'fa';
  if(arabic.test(text)) return 'ar';
  return 'en';
}

function callCreator(){window.location.href="tel:09211243320";}
function toggleChat(){chatContainer.style.display==='flex'?closeChat():openChat();}
function openChat(){
  chatContainer.style.display='flex';
  chatContainer.classList.add('show');
  chatToggleBtn.classList.add('active');
  if(window.innerWidth<=768){chatToggleBtn.style.visibility='hidden';chatToggleBtn.style.opacity='0';}
}
function closeChat(){
  chatContainer.classList.remove('show');
  setTimeout(()=>{chatContainer.style.display='none';},400);
  chatToggleBtn.classList.remove('active');
  if(window.innerWidth<=768){chatToggleBtn.style.visibility='visible';chatToggleBtn.style.opacity='1';}
}

function renderMessages(){
  chatBox.innerHTML='';
  messages.forEach(msg=>{
    const div=document.createElement("div");
    div.className="message "+(msg.role==="user"?"user":"assistant");
    div.innerHTML=`${msg.content}<span class="msg-time">${msg.time||""}</span>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
}

function searchJSON(query, lang){
  if(!jsonData) return null;
  query=query.toLowerCase();
  if(jsonData.company.name.toLowerCase().includes(query)){
    let text=`ŸÜÿßŸÖ ÿ¥ÿ±⁄©ÿ™: ${jsonData.company.name}\nÿ™ŸÑŸÅŸÜ‚ÄåŸáÿß: ${jsonData.company.phones.join(', ')}\nÿ¢ÿØÿ±ÿ≥ ÿØŸÅÿ™ÿ±: ${jsonData.company.addresses.office}\nÿ≥ÿßÿπÿ™ ⁄©ÿßÿ±€å: ${jsonData.company.working_hours}`;
    if(lang!=='fa') text=translateToEnglish(text);
    return text;
  }
  for(const page of jsonData.pages){
    if(page.title.toLowerCase().includes(query)||(page.summary&&page.summary.toLowerCase().includes(query))){
      let text=`${page.title}\n${page.summary||''}`;
      if(page.items) text+='\nŸÖŸàÿßÿ±ÿØ: '+page.items.map(i=>i.title).join(', ');
      if(lang!=='fa') text=translateToEnglish(text);
      return text;
    }
    if(page.products){
      const found=page.products.find(p=>p.title.toLowerCase().includes(query));
      if(found){
        let text=`ŸÖÿ≠ÿµŸàŸÑ: ${found.title}\nŸÑ€åŸÜ⁄©: ${found.url}`;
        if(lang!=='fa') text=translateToEnglish(text);
        return text;
      }
    }
  }
  return null;
}

function translateToEnglish(text){
  const mapping={"ŸÜÿßŸÖ ÿ¥ÿ±⁄©ÿ™":"Company Name","ÿ™ŸÑŸÅŸÜ‚ÄåŸáÿß":"Phones","ÿ¢ÿØÿ±ÿ≥ ÿØŸÅÿ™ÿ±":"Office Address","ÿ≥ÿßÿπÿ™ ⁄©ÿßÿ±€å":"Working Hours","ŸÖŸàÿßÿ±ÿØ":"Items","ŸÖÿ≠ÿµŸàŸÑ":"Product"};
  for(const key in mapping) text=text.replaceAll(key,mapping[key]);
  return text;
}

const restrictedPatterns=[
  /(⁄©ÿØ|ÿ®ÿ±ŸÜÿßŸÖŸá|ÿ™ÿ®ÿØ€åŸÑ|ŸÖÿ≠ÿßÿ≥ÿ®Ÿá|run|code)/i,
  /(ÿ¨Ÿà⁄©|ÿØÿßÿ≥ÿ™ÿßŸÜ|ÿ¥ÿπÿ±|ÿπÿßÿ¥ŸÇÿßŸÜŸá|ÿ≠ŸàÿµŸÑŸá|ÿ±ŸàÿßŸÜÿ¥ŸÜÿßÿ≥€å|Ÿæÿ≤ÿ¥⁄©€å|ÿ≠ŸÇŸàŸÇ€å|ÿ™ÿ≠ÿµ€åŸÑ€å)/i,
  /(ŸÅÿßŸÑ|Ÿæ€åÿ¥‚Äåÿ®€åŸÜ€å|ŸÅŸÑÿ≥ŸÅ€å|ÿØ€åŸÜ€å)/i,
  /(ÿØŸàÿ≥ÿ™ ÿØÿßÿ¥ÿ™ŸÜ|ÿπÿßÿ¥ŸÇ|ÿ±ÿßÿ®ÿ∑Ÿá|ÿ≤ŸÜÿØ⁄Ø€å ÿ¥ÿÆÿµ€å)/i,
  /(ÿ≥€åÿßÿ≥ÿ™|Ÿàÿ±ÿ≤ÿ¥|ŸÅ€åŸÑŸÖ|ŸÖŸàÿ≥€åŸÇ€å|ÿßŸÅÿ±ÿßÿØ ŸÖÿ¥ŸáŸàÿ±)/i,
  /(Ÿá⁄©|ŸÜŸÅŸàÿ∞|ŸÖÿ≠ÿ±ŸÖÿßŸÜŸá|ŸÑ€åŸÜ⁄© ŸÖÿ¥⁄©Ÿà⁄©)/i
];

function checkRestrictedContent(text){return restrictedPatterns.some(p=>p.test(text));}

function checkBlockStatus(){
  const blockData=JSON.parse(localStorage.getItem('blockData')||'{}');
  if(blockData.expire && new Date(blockData.expire)>new Date()) return true;
  localStorage.removeItem('blockData');
  return false;
}

function recordRestriction(lang){
  let count=parseInt(localStorage.getItem('restrictionCount')||'0')+1;
  localStorage.setItem('restrictionCount',count);
  if(count>=RESTRICT_LIMIT){
    const expireDate=new Date();
    expireDate.setHours(expireDate.getHours()+BLOCK_HOURS);
    localStorage.setItem('blockData',JSON.stringify({expire:expireDate}));
    localStorage.setItem('restrictionCount',0);
  }
  return count;
}

function getWarningMessage(lang,count){
  const messages={
    fa:`‚ö†Ô∏è Ÿáÿ¥ÿØÿßÿ±: ÿ¥ŸÖÿß ${count} ÿ®ÿßÿ± ÿ≥ŸàÿßŸÑ ÿÆÿßÿ±ÿ¨ ÿßÿ≤ ÿ≠Ÿàÿ≤Ÿá Ÿæÿ±ÿ≥€åÿØŸá‚Äåÿß€åÿØ. ÿßÿØÿßŸÖŸá ÿØÿßÿØŸÜ ÿ®ÿßÿπÿ´ ŸÖÿ≥ÿØŸàÿØ ÿ¥ÿØŸÜ ÿ≠ÿ≥ÿßÿ® ÿ¥ŸÖÿß ÿ®Ÿá ŸÖÿØÿ™ ${BLOCK_HOURS} ÿ≥ÿßÿπÿ™ ŸÖ€å‚Äåÿ¥ŸàÿØ.`,
    en:`‚ö†Ô∏è Warning: You have asked ${count} out-of-scope questions. Continuing will block your account for ${BLOCK_HOURS} hours.`,
    ar:`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ŸÑŸÇÿØ ÿ∑ÿ±ÿ≠ÿ™ ${count} ÿ£ÿ≥ÿ¶ŸÑÿ© ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÜÿ∑ÿßŸÇ. ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿ≥Ÿäÿ§ÿØŸä ÿ•ŸÑŸâ ÿ≠ÿ∏ÿ± ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÑŸÖÿØÿ© ${BLOCK_HOURS} ÿ≥ÿßÿπÿ©.`
  };
  return messages[lang]||messages['en'];
}

function getRestrictionMessage(lang){
  const messages={
    fa:'ŸÖÿ™ÿßÿ≥ŸÅŸÖÿå ŸÖŸÜ ŸÅŸÇÿ∑ ÿØÿ± ÿ≤ŸÖ€åŸÜŸá ŸÖÿπÿ±ŸÅ€å ÿ¥ÿ±⁄©ÿ™ÿå ŸÖÿ≠ÿµŸàŸÑÿßÿ™ Ÿà ÿÆÿØŸÖÿßÿ™ ÿ¢ŸÜ Ÿæÿßÿ≥ÿÆ⁄ØŸà Ÿáÿ≥ÿ™ŸÖ.\nŸÑÿ∑ŸÅÿßŸã ÿ≥ŸàÿßŸÑÿßÿ™ ÿÆŸàÿØ ÿ±ÿß ÿØÿ± ÿß€åŸÜ ÿ≠Ÿàÿ≤Ÿá ŸÖÿ∑ÿ±ÿ≠ ⁄©ŸÜ€åÿØ.',
    en:'Sorry, I only respond regarding company introduction, products, and services.\nPlease ask questions in this domain.',
    ar:'ÿπÿ∞ÿ±ÿßŸãÿå ÿ£ŸÜÿß ÿ£ÿ¨Ÿäÿ® ŸÅŸÇÿ∑ ÿ≠ŸàŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©ÿå ŸÖŸÜÿ™ÿ¨ÿßÿ™Ÿáÿß ŸàÿÆÿØŸÖÿßÿ™Ÿáÿß.\nŸäÿ±ÿ¨Ÿâ ÿ∑ÿ±ÿ≠ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¨ÿßŸÑ.'
  };
  return messages[lang]||messages['en'];
}

userInput.addEventListener("keydown",function(e){
  if(e.key==="Enter"){ e.preventDefault(); if(!isTyping) sendMessage(); }
});

async function sendMessage(){
  if(isTyping) return;
  const content=userInput.value.trim();
  if(!content) return;
  const lang=detectLanguage(content);

  if(checkBlockStatus()){
    const msg=getRestrictionMessage(lang)+'\n‚õî ÿ¥ŸÖÿß ÿ®Ÿá ŸÖÿØÿ™ '+BLOCK_HOURS+' ÿ≥ÿßÿπÿ™ ŸÖÿ≥ÿØŸàÿØ ÿ¥ÿØŸá‚Äåÿß€åÿØ.';
    messages.push({role:"assistant",content:msg,time:new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})});
    renderMessages();
    userInput.value="";
    return;
  }

  if(checkRestrictedContent(content)){
    const count=recordRestriction(lang);
    const warningMsg=getWarningMessage(lang,count);
    const msg=getRestrictionMessage(lang)+'\n'+warningMsg;
    messages.push({role:"assistant",content:msg,time:new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})});
    renderMessages();
    userInput.value="";
    return;
  }

  messages.push({role:"user",content,time:new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})});
  renderMessages();
  userInput.value="";
  typingIndicator.style.display='block';
  stopTyping=false;
  isTyping=true;

  const jsonReply=searchJSON(content,lang);
  if(jsonReply){ await simulateTyping(jsonReply); return; }

  try{
    const apiResponse=await fetch("https://api.gapgpt.app/v1/chat/completions",{
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":`Bearer ${GAP_TOKEN}`},
      body:JSON.stringify({model:"gpt-4o",messages:messages.map(({role,content})=>({role,content})),max_tokens:400})
    });
    const data=await apiResponse.json();
    let reply=data.choices?.[0]?.message?.content||(lang==='fa'?'Ÿæÿßÿ≥ÿÆ ŸÜÿßŸÖÿ¥ÿÆÿµ ÿØÿ±€åÿßŸÅÿ™ ÿ¥ÿØ.':'Unknown response received.');
    await simulateTyping(reply);
  }catch(err){
    await simulateTyping(lang==='fa'?'ÿÆÿ∑ÿß ÿØÿ± ÿßÿ™ÿµÿßŸÑ €åÿß ÿßÿπÿ™ÿ®ÿßÿ± ÿ™Ÿà⁄©ŸÜ.':'Token error or connection failed.');
  }
}

async function simulateTyping(text){
  messages.push({role:"assistant",content:"",time:new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})});
  renderMessages();
  let i=0;
  return new Promise(resolve=>{
    typingInterval=setInterval(()=>{
      if(stopTyping||i>=text.length){
        clearInterval(typingInterval);
        typingIndicator.style.display='none';
        isTyping=false;
        renderMessages();
        resolve();
        return;
      }
      messages[messages.length-1].content+=text[i];
      renderMessages();
      i++;
    },30);
  });
}
</script>
</body>
</html>
