<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BK-AI Chat â€” Company-focused Assistant</title>
<style>
  /* Ø³Ø¨Ú©â€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø«Ù„ Ù†Ø³Ø®Ù‡Ù” Ù‚Ø¨Ù„ÛŒ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ… (Ù…Ø®ØªØµØ±) */
  body{margin:0;font-family:'Vazir','Segoe UI',sans-serif;background:#f9fafb;}
  .chat-toggle-btn{position:fixed;bottom:20px;right:20px;width:70px;height:70px;background:#8b5cf6;border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:1001;box-shadow:0 8px 20px rgba(139,92,246,0.35);cursor:pointer;}
  .chat-toggle-btn:hover{background:#22c55e;}
  #chatContainer{display:none;position:fixed;bottom:90px;right:20px;width:420px;height:640px;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);overflow:hidden;z-index:1000;display:flex;flex-direction:column;}
  .chat-header{background:linear-gradient(90deg,#3b82f6,#8b5cf6);color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center;font-weight:600;}
  .chat-box{flex:1;padding:12px;overflow:auto;background:#f7fafc;}
  .message{margin-bottom:10px;padding:8px 10px;border-radius:12px;max-width:80%;white-space:pre-wrap;}
  .user{background:#dbeafe;margin-left:auto;text-align:left;}
  .assistant{background:#f3f4f6;margin-right:auto;text-align:left;}
  .msg-time{font-size:11px;color:#9aa0a6;margin-top:6px;display:block;text-align:right;}
  .input-area{display:flex;padding:10px;border-top:1px solid #e6e6e6;background:#fff;gap:8px;}
  input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;}
  button.send-btn{background:#3b82f6;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;}
  button.send-btn:disabled{background:#a5b4fc;cursor:not-allowed;}
  .typing{font-style:italic;color:#6b7280;padding:6px 10px;display:none;}
  .cta{margin-top:6px;padding:8px;border-radius:8px;background:linear-gradient(90deg,#fef3c7,#fde68a);}
  .small{font-size:12px;color:#555;margin-top:6px;}
  @media(max-width:768px){#chatContainer{width:100%;height:100%;right:0;bottom:0;border-radius:0;}}
</style>
</head>
<body>

<button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChat()">ğŸ’¬</button>

<div id="chatContainer" aria-hidden="true">
  <div class="chat-header">
    <div>BK Assistant</div>
    <div>
      <button onclick="callCreator()" style="margin-right:8px;">ğŸ“</button>
      <button onclick="closeChat()">âœ•</button>
    </div>
  </div>

  <div class="chat-box" id="chatBox"></div>

  <div class="typing" id="typingIndicator">Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...</div>

  <div class="input-area">
    <input id="userInput" type="text" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." />
    <button id="sendBtn" class="send-btn" onclick="sendMessage()">Ø§Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
/* =================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ =================== */
const GAP_TOKEN = "sk-T15TGdP9wukEdUzMiP6dJRIYI0oQ1mbx0jdtS7SDAmuZor4G"; // Ø§Ú¯Ø± Ù„Ø§Ø²Ù…Ù‡ Ø¹ÙˆØ¶ Ú©Ù†
const JSON_URL = "https://raw.githubusercontent.com/mahdiklidari190/AI-PRO/main/data.json";

/* Ù†Ø±Ø®â€ŒØ¯Ù‡ÛŒ Ùˆ Ø¨Ù„Ø§Ú© (soft limits) */
const SOFT_WINDOW_MS = 5 * 60 * 1000;    // Ù¾Ù†Ø¬Ø±Ù‡Ù” Ù†Ø±Ù…: 5 Ø¯Ù‚ÛŒÙ‚Ù‡
const SOFT_LIMIT = 30;                   // ØªØ§ 30 Ù¾ÛŒØ§Ù… Ø¯Ø± Ù‡Ø± Ù¾Ù†Ø¬Ø±Ù‡ Ø§Ø¬Ø§Ø²Ù‡Ù” Ø·Ø¨ÛŒØ¹ÛŒ
const WARN_THRESHOLD = 20;               // ÙˆÙ‚ØªÛŒ Ø¨Ù‡ 20 Ø±Ø³ÛŒØ¯ Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø¯Ù‡
const ABUSE_LIMIT = 60;                  // Ø§Ú¯Ø± Ø®ÛŒÙ„ÛŒ Ø²ÛŒØ§Ø¯Ù‡ (Ù…Ø«Ù„Ø§Ù‹ DDoS-like) => Ø¨Ù„ÙˆÚ© Ú©ÙˆØªØ§Ù‡
const SHORT_BLOCK_MS = 10 * 60 * 1000;   // Ø¨Ù„ÙˆÚ© Ú©ÙˆØªØ§Ù‡: 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ø§ÛŒ Ø±ÙØªØ§Ø± Ø®ÛŒÙ„ÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¹Ø±Ù

/* Ø¨Ù„Ø§Ú© Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ø² Ø­ÙˆØ²Ù‡ (Ú©Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ø±Ø¯ÛŒ): */
const RESTRICT_LIMIT = 3;    // Ú†Ù†Ø¯ Ø§Ø®Ø·Ø§Ø± Ù‚Ø¨Ù„ Ø§Ø² 5 Ø³Ø§Ø¹Øª Ø¨Ù†
const BLOCK_HOURS_FOR_RESTRICT = 5;

/* Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ */
let messages = [];
let jsonData = null;
let typingInterval = null;
let stopTyping = false;
let isTyping = false;

/* Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ */
const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const typingIndicator = document.getElementById('typingIndicator');
const chatContainer = document.getElementById('chatContainer');
const chatToggleBtn = document.getElementById('chatToggleBtn');

/* =================== Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ JSON Ø´Ø±Ú©Øª =================== */
async function loadJSON(){
  try{
    const r = await fetch(JSON_URL);
    jsonData = await r.json();
    // console.log("loaded JSON", jsonData);
  }catch(e){
    console.warn("can't load data.json:", e);
    jsonData = null;
  }
}
loadJSON();

/* =================== Ú©Ù…Ú©â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§ =================== */
function detectLanguage(text){
  const persian = /[\u0600-\u06FF]/;
  const arabic = /[\u0750-\u077F\u08A0-\u08FF]/;
  const cjk = /[\u4e00-\u9fff]/;
  if(persian.test(text)) return 'fa';
  if(arabic.test(text)) return 'ar';
  if(cjk.test(text)) return 'zh';
  // very simple heuristics; fallback en
  return 'en';
}

function nowTimeStr(){
  return new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
}

/* =================== Ø±ÙØªØ§Ø± Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ (Ø§Ú¯Ø± Ù…ÙˆØ±Ø¯ Ù…Ø±ØªØ¨Ø· Ù¾ÛŒØ¯Ø§ Ø´Ø¯) =================== */
function marketingResponseForProduct(product, lang){
  // Ù…Ø­ØµÙˆÙ„ ÙØ±Ø¶ÛŒ: { title, url, price, summary, features: [] }
  // Ù‚Ø§Ù„Ø¨â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø® Ù…ØªÙ‚Ø§Ø¹Ø¯Ú©Ù†Ù†Ø¯Ù‡ Ø¨Ù‡ Ø²Ø¨Ø§Ù† Ú©Ø§Ø±Ø¨Ø±
  const title = product.title || product.name || "Ù…Ø­ØµÙˆÙ„";
  const summary = product.summary || "";
  const url = product.url || product.link || "";
  const features = (product.features && Array.isArray(product.features))? product.features.slice(0,3) : [];

  const ctaEn = `You can get it here: ${url}`;
  const ctaFa = `Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ / Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±: ${url}`;
  const ctaAr = `Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬: ${url}`;

  let base = "";
  if(lang==='fa'){
    base += `Ù…Ø­ØµÙˆÙ„ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: ${title}\n${summary}\n`;
    if(features.length) base += `ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ: ${features.join(' Â· ')}\n`;
    base += `Ù‚ÛŒÙ…Øª (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯): ${product.price ? product.price : 'ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯'}\n`;
    base += `${ctaFa}\n`;
    base += `Ù†Ú©ØªÙ‡: Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø®Ø±ÛŒØ¯ ÛŒØ§ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯ÛŒÚ¯Ø± Ø±Ø§ Ø¨ÙØ±Ø³ØªÛŒØ¯.`;
  } else if(lang==='ar'){
    base += `Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${title}\n${summary}\n`;
    if(features.length) base += `Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: ${features.join(' Â· ')}\n`;
    base += `${ctaAr}\n`;
  } else {
    base += `Recommended product: ${title}\n${summary}\n`;
    if(features.length) base += `Key features: ${features.join(' Â· ')}\n`;
    base += `${product.price ? `Price: ${product.price}\n` : ''}${ctaEn}\n`;
    base += `Tip: ask for comparison or installation options.`;
  }
  return base;
}

/* Ø§Ú¯Ø± ØµÙØ­Ù‡ ÛŒØ§ Ù…Ø­ØµÙˆÙ„ Ù…Ø±ØªØ¨Ø· Ù¾ÛŒØ¯Ø§ Ø´Ø¯ØŒ Ø¬ÙˆØ§Ø¨ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… */
function searchJSONAndBuildMarketing(query, lang){
  if(!jsonData) return null;
  const q = query.toLowerCase();

  // Ø§ÙˆÙ„ Ø³ÛŒØ± Ù…Ù†Ø·Ù‚ÛŒ: Ø´Ø±Ú©ØªØŒ ØµÙØ­Ø§ØªØŒ Ù…Ø­ØµÙˆÙ„Ø§Øª
  if(jsonData.company && jsonData.company.name && jsonData.company.name.toLowerCase().includes(q)){
    let txt = `Ù†Ø§Ù… Ø´Ø±Ú©Øª: ${jsonData.company.name}\n`;
    if(jsonData.company.phones) txt += `ØªÙ„ÙÙ†â€ŒÙ‡Ø§: ${jsonData.company.phones.join(', ')}\n`;
    if(jsonData.company.addresses?.office) txt += `Ø¢Ø¯Ø±Ø³: ${jsonData.company.addresses.office}\n`;
    txt += `Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ø§ Ø³ÙˆØ§Ù„ Ø¨Ù¾Ø±Ø³ÛŒØ¯ ÛŒØ§ Ø¨Ú¯ÙˆÛŒÛŒØ¯ Ø¯Ù†Ø¨Ø§Ù„ Ú†Ù‡ Ù…Ø­ØµÙˆÙ„ÛŒ Ù‡Ø³ØªÛŒØ¯.`;
    return (lang==='fa')? txt : (lang==='ar'? txt : txt);
  }

  // Ø¬Ø³ØªØ¬ÙˆÛŒ ØµÙØ­Ø§Øª
  if(Array.isArray(jsonData.pages)){
    for(const page of jsonData.pages){
      const title = (page.title||"").toLowerCase();
      const summary = (page.summary||"").toLowerCase();
      if(title.includes(q) || summary.includes(q)){
        let txt = `${page.title}\n${page.summary||''}\n`;
        if(page.items) txt += 'Ù…ÙˆØ§Ø±Ø¯: '+ page.items.map(i=>i.title).slice(0,5).join(' Â· ') + '\n';
        return (lang==='fa')? txt : txt;
      }
      // Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯Ø± ØµÙØ­Ù‡
      if(page.products){
        const found = page.products.find(p => (p.title||'').toLowerCase().includes(q) || (p.summary||'').toLowerCase().includes(q));
        if(found) return marketingResponseForProduct(found, lang);
      }
    }
  }

  // Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯Ø± Ø±ÛŒØ´Ù‡
  if(Array.isArray(jsonData.products)){
    const found = jsonData.products.find(p=> (p.title||'').toLowerCase().includes(q) || (p.summary||'').toLowerCase().includes(q));
    if(found) return marketingResponseForProduct(found, lang);
  }

  return null;
}

/* =================== Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…ÙˆØ¶ÙˆØ¹ÛŒ (Ù‡Ù…Ø§Ù† Ú©Ù‡ Ø®ÙˆØ§Ø³ØªÛŒ) =================== */
const restrictedPatterns = [
  /(^|\s)(Ú©Ø¯|Ø¨Ø±Ù†Ø§Ù…Ù‡|Ù¾Ø§ÛŒØªÙˆÙ†|python|java|javascript|run|script)(\s|$)/i,
  /Ù…Ø­Ø§Ø³Ø¨Ø§Øª|ÙˆØ§Ø­Ø¯|Ø±ÛŒØ§Ø¶ÛŒ|math/i,
  /Ø¯ÛŒØ¨Ø§Ú¯|debug|api|Ø¯ÛŒØªØ§Ø¨ÛŒØ³|database/i,
  /Ø¬ÙˆÚ©|Ø¯Ø§Ø³ØªØ§Ù†|Ø´Ø¹Ø±|Ø¹Ø§Ø´Ù‚Ø§Ù†Ù‡|Ø­ÙˆØµÙ„Ù‡|talk/i,
  /Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ|Ù¾Ø²Ø´Ú©ÛŒ|Ø­Ù‚ÙˆÙ‚|ØªØ­ØµÛŒÙ„ÛŒ|Ù…Ø´Ø§ÙˆØ±Ù‡/i,
  /ÙØ§Ù„|Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ|Ù¾ÛŒØ´Ú¯ÙˆÛŒÛŒ|fortune/i,
  /ÙÙ„Ø³ÙÙ‡|Ø¯ÛŒÙ†/i,
  /Ø¯ÙˆØ³Øª|Ø¹Ù„Ø§Ù‚Ù‡|relationship|love/i,
  /Ø³ÛŒØ§Ø³Øª|ÙˆØ±Ø²Ø´|ÙÛŒÙ„Ù…|Ù…ÙˆØ³ÛŒÙ‚ÛŒ|Ø§ÙØ±Ø§Ø¯ Ù…Ø´Ù‡ÙˆØ±|celebrity/i,
  /ØªØ±Ø¬Ù…Ù‡|article|content/i,
  /Ø®Ø´ÙˆÙ†Øª|Ù‡Ú©|Ù†ÙÙˆØ°|hack|exploit/i,
  /Ù…Ø­Ø±Ù…Ø§Ù†Ù‡|confidential|personal/i,
  /Ù„ÛŒÙ†Ú© Ù…Ø´Ú©ÙˆÚ©|ØªØ¨Ù„ÛŒØº/i
];

function isRestricted(text){
  return restrictedPatterns.some(p => p.test(text));
}

function getRestrictionReply(lang){
  const map = {
    fa: "Ù…ØªØ§Ø³ÙÙ…ØŒ Ù…Ù† ÙÙ‚Ø· Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ø´Ø±Ú©ØªØŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ Ø®Ø¯Ù…Ø§Øª Ø¢Ù† Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ù…. Ù„Ø·ÙØ§Ù‹ Ø³ÙˆØ§Ù„ØªØ§Ù† Ø±Ø§ Ø¯Ø± Ù‡Ù…ÛŒÙ† Ø­ÙˆØ²Ù‡ Ù…Ø·Ø±Ø­ Ú©Ù†ÛŒØ¯.",
    en: "Sorry â€” I only answer about the company, its products and services. Please ask within that domain.",
    ar: "Ø¹Ø°Ø±Ø§Ù‹ â€” Ø£Ø¬ÙŠØ¨ ÙÙ‚Ø· Ø¹Ù† Ø£Ø³Ø¦Ù„Ø© Ø­ÙˆÙ„ Ø§Ù„Ø´Ø±ÙƒØ© ÙˆÙ…Ù†ØªØ¬Ø§ØªÙ‡Ø§ ÙˆØ®Ø¯Ù…Ø§ØªÙ‡Ø§. ÙŠØ±Ø¬Ù‰ Ø·Ø±Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚.",
    zh: "æŠ±æ­‰â€”â€”æˆ‘åªå›ç­”æœ‰å…³å…¬å¸ã€äº§å“å’ŒæœåŠ¡çš„é—®é¢˜ã€‚è¯·åœ¨æ­¤èŒƒå›´å†…æé—®ã€‚",
  };
  return map[lang]||map['en'];
}

/* =================== Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡Ù” Ù¾ÛŒØ§Ù… (soft rate limiting) =================== */
/* Ù…Ø§ ÛŒÚ© Ù„Ø§Ú¯ Ø¯Ø± sessionStorage Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… (Ø¬Ù„Ø³Ù‡ ÙØ¹Ù„ÛŒ)Ø› Ø§ÛŒÙ† Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ÛŒÚ© Ø³Ø´Ù† Ù…Ù†Ø·Ù‚ÛŒ Ú†Øª Ú©Ù†Ø¯ Ø§Ù…Ø§ Ø§Ú¯Ø± Ø§Ø±Ø³Ø§Ù„â€ŒÙ‡Ø§ Ø³Ø±ÛŒØ¹ Ø´Ø¯ Ù‡Ø´Ø¯Ø§Ø±/ÙˆÙ‚ÙÙ‡ Ø¨Ø¯Ù‡ÛŒÙ… */
function logMessageTimestamp(){
  const key = 'bk_msg_log';
  const raw = sessionStorage.getItem(key);
  let arr = raw? JSON.parse(raw) : [];
  const now = Date.now();
  arr.push(now);
  // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒÙ‡Ø§ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù¾Ù†Ø¬Ø±Ù‡
  arr = arr.filter(t => now - t <= SOFT_WINDOW_MS);
  sessionStorage.setItem(key, JSON.stringify(arr));
  return arr.length;
}

function oversizedBehavior(count){
  // Ø§Ú¯Ø± Ø¯Ø± Ù¾Ù†Ø¬Ø±Ù‡ Ø®ÛŒÙ„ÛŒ Ø²ÛŒØ§Ø¯ Ø´Ø¯: Ø§Ø®Ø·Ø§Ø± Ø§ÙˆÙ„ØŒ Ø¨Ø¹Ø¯ Ø¨Ù„ÙˆÚ© Ú©ÙˆØªØ§Ù‡ Ø¯Ø± ØµÙˆØ±Øª ØªÚ©Ø±Ø§Ø±
  if(count >= ABUSE_LIMIT){
    // Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù„ÙˆÚ© Ú©ÙˆØªØ§Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª sessionStorage
    const blockUntil = Date.now() + SHORT_BLOCK_MS;
    sessionStorage.setItem('bk_short_block', String(blockUntil));
    return {blocked:true, reason:'short_block'};
  }
  if(count >= SOFT_LIMIT){
    // soft limit => Ú©Ù…ÛŒ Ø®Ù†Ú© Ø´Ùˆ: Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒÚ¯ÙˆÛŒÛŒÙ… ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø²ÛŒØ§Ø¯ Ø§Ø³Øª Ùˆ Ø­Ø§Ù„Ø§ 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø±Ø§ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù†
    return {warn:true, reason:'soft_limit'};
  }
  if(count >= WARN_THRESHOLD){
    return {warn:true, reason:'warn_threshold'};
  }
  return {};
}

function checkShortBlock(){
  const v = sessionStorage.getItem('bk_short_block');
  if(!v) return false;
  if(Date.now() > Number(v)){ sessionStorage.removeItem('bk_short_block'); return false; }
  return true;
}

/* =================== Ø³ÛŒØ³ØªÙ… Ø¨Ù„Ø§Ú© Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ø² Ø­ÙˆØ²Ù‡ (persisted) =================== */
function getRestrictData(){
  return JSON.parse(localStorage.getItem('bk_restrict')||'{}');
}
function setRestrictData(obj){ localStorage.setItem('bk_restrict', JSON.stringify(obj)); }

/* recordRestriction: Ø¨Ø± Ø§Ø³Ø§Ø³ RESTRICT_LIMIT Ù‡Ø´Ø¯Ø§Ø±/Ø¨Ù„Ø§Ú© Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ */
function recordRestrictionViolation(lang){
  const d = getRestrictData();
  d.count = (d.count||0) + 1;
  if(d.count >= RESTRICT_LIMIT){
    const until = Date.now() + BLOCK_HOURS_FOR_RESTRICT * 3600 * 1000;
    d.blockUntil = until;
    d.count = 0; // Ø±ÛŒØ³Øª Ù¾Ø³ Ø§Ø² Ø¨Ù„Ø§Ú©
  }
  setRestrictData(d);
  return d;
}

function checkRestrictBlock(){
  const d = getRestrictData();
  if(d.blockUntil && Date.now() < d.blockUntil) return true;
  return false;
}

/* =================== UI: ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ =================== */
function pushMessage(role, content){
  messages.push({role, content, time: nowTimeStr()});
  renderMessages();
}
function renderMessages(){
  chatBox.innerHTML = '';
  messages.forEach(m => {
    const div = document.createElement('div');
    div.className = 'message ' + (m.role === 'user' ? 'user' : 'assistant');
    div.innerHTML = `<div>${escapeHtml(m.content).replace(/\n/g,'<br/>')}</div><div class="msg-time">${m.time||''}</div>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* =================== Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ =================== */
userInput.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){ e.preventDefault(); if(!isTyping) sendMessage(); }
});

/* Ù†Ù…Ø§ÛŒØ´ Ù‡Ø´Ø¯Ø§Ø± Ø¨Ù„Ø§Ú© Ø¨Ù„Ù†Ø¯ Ù…Ø¯Øª (Ø§Ú¯Ø± ÙØ¹Ø§Ù„) */
(function initBlockState(){
  const restrictData = getRestrictData();
  if(restrictData.blockUntil && Date.now() < restrictData.blockUntil){
    const lang = 'fa';
    pushMessage('assistant', getRestrictionReply(lang) + '\nâ›” Ø´Ù…Ø§ ØªØ§ ' + Math.ceil((restrictData.blockUntil - Date.now())/(3600*1000)) + ' Ø³Ø§Ø¹Øª Ù…Ø­Ø¯ÙˆØ¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.');
    userInput.disabled = true;
    sendBtn.disabled = true;
  }
})();

/* =================== ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… =================== */
async function sendMessage(){
  if(isTyping) return;
  // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù„ÙˆÚ© Ú©ÙˆØªØ§Ù‡ session
  if(checkShortBlock()){
    pushMessage('assistant', 'Ø³ÛŒØ³ØªÙ…: Ø­Ø¬Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø®ÛŒÙ„ÛŒ Ø¨Ø§Ù„Ø§Ø³Øª. Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
    return;
  }
  // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù„Ø§Ú© Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ø² Ø­ÙˆØ²Ù‡
  if(checkRestrictBlock()){
    const d = getRestrictData();
    // Ø²Ø¨Ø§Ù† Ø±Ø§ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ù†Ú¯ÛŒØ±ÛŒØ¯Ø› Ú†ÙˆÙ† Ú©Ø§Ø±Ø¨Ø± Ù…Ù…Ú©Ù† Ø§Ø³Øª ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ù‡Ø± Ø²Ø¨Ø§Ù† Ø¨Ø§Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø² detectLanguage Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
    const currentLang = detectLanguage(userInput.value || '');
    pushMessage('assistant', getRestrictionReply(currentLang) + '\nâ›” Ø´Ù…Ø§ ØªØ§ ' + Math.ceil((d.blockUntil - Date.now())/(3600*1000)) + ' Ø³Ø§Ø¹Øª Ù…Ø­Ø¯ÙˆØ¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.');
    userInput.value = '';
    return;
  }

  const text = userInput.value.trim();
  if(!text) return;
  const lang = detectLanguage(text);

  // Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„: Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø±Ø®
  const count = logMessageTimestamp();
  const behavior = oversizedBehavior(count);
  if(behavior.blocked){
    pushMessage('assistant', (lang==='fa'?'ØªØ±Ø§ÙÛŒÚ© Ø®ÛŒÙ„ÛŒ Ø¨Ø§Ù„Ø§Ø³Øª â€” Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚ØªÛŒ Ù…Ø­Ø¯ÙˆØ¯ Ø´Ø¯.':'High traffic â€” temporary block applied.'));
    userInput.value = '';
    return;
  }
  if(behavior.warn){
    pushMessage('assistant', (lang==='fa'?'Ù‡Ø´Ø¯Ø§Ø±: Ø³Ø±Ø¹Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø§Ù„Ø§Ø³Øª â€” Ù„Ø·ÙØ§Ù‹ Ú©Ù†Ø¯ØªØ± Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.':'Warning: message rate high â€” please slow down.'));
    // Ø§Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… Ù¾ÛŒØ§Ù… ÙØ¹Ù„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ (soft)
  }

  // Ø­Ø§Ù„Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…ÙˆØ¶ÙˆØ¹ÛŒ (Ø§Ú¯Ø± Ø®Ø§Ø±Ø¬ Ø§Ø² Ø­ÙˆØ²Ù‡ Ø§Ø³ØªØŒ Ø¬ÙˆØ§Ø¨ Ù…Ø­Ø¯ÙˆØ¯ÛŒ Ø¨Ø¯Ù‡ ÛŒØ§ Ø§Ø®Ø·Ø§Ø±)
  if(isRestricted(text)){
    // Ø«Ø¨Øª ØªØ®Ù„Ù Ùˆ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ
    const d = recordRestrictionViolation(lang);
    const times = (d.count || 0);
    if(d.blockUntil && Date.now() < d.blockUntil){
      pushMessage('assistant', getRestrictionReply(lang) + '\nâ›” ' + (lang==='fa'?`Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ØªØ§ ${BLOCK_HOURS_FOR_RESTRICT} Ø³Ø§Ø¹Øª Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯.`:`Your account has been blocked for ${BLOCK_HOURS_FOR_RESTRICT} hours.`));
      userInput.value = '';
      userInput.disabled = true;
      sendBtn.disabled = true;
      return;
    } else {
      // Ø§Ú¯Ø± Ø¨Ù‡ Ø­Ø¯ Ø§Ø®Ø·Ø§Ø± Ù†Ø±Ø³ÛŒØ¯Ù‡ ÛŒØ§ Ù‡Ù†ÙˆØ² Ø¨Ù† Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø®Ø·Ø§Ø± Ù…Ù†ØªØ´Ø± Ú©Ù† (ØªØ¹Ø¯Ø§Ø¯ Ø¯ÙØ¹Ø§Øª)
      const warnCount = d.count || 0;
      pushMessage('assistant', getRestrictionReply(lang) + '\n' + (lang==='fa'? `âš ï¸ Ù‡Ø´Ø¯Ø§Ø± (${warnCount}/${RESTRICT_LIMIT}) â€” Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø¯Ù† Ù…ÙˆØ¬Ø¨ Ù…Ø³Ø¯ÙˆØ¯ÛŒ ${BLOCK_HOURS_FOR_RESTRICT} Ø³Ø§Ø¹ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.` : `âš ï¸ Warning (${warnCount}/${RESTRICT_LIMIT}) â€” continuing will block you for ${BLOCK_HOURS_FOR_RESTRICT} hours.`));
      userInput.value = '';
      return;
    }
  }

  // Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø«Ø¨Øª Ú©Ù† Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡
  pushMessage('user', text);
  userInput.value = '';

  // Ø§Ú¯Ø± JSON Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø±ØªØ¨Ø· Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† Ùˆ ØªØ¨Ù„ÛŒØº Ú©Ù†
  const marketing = searchJSONAndBuildMarketing(text, lang);
  if(marketing){
    // Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ: Ø§ÙˆÙ„ Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø¯Ù‡ Ùˆ ÛŒÚ© CTA Ù…Ø´Ø®Øµ
    await simulateTyping(marketing);
    return;
  }

  // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯Ù‡ Ù…Ø¯Ù„ Ù¾Ø§Ø³Ø® Ø¨Ø¯Ù‡ (ÙˆÙ„ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…Ú©Ø§Ù„Ù…Ù‡: max_tokens Ùˆ max_history)
  isTyping = true;
  typingIndicator.style.display = 'block';
  sendBtn.disabled = true;
  sendBtn.textContent = (lang==='fa'?'ØªÙˆÙ‚Ù':'Stop');

  try{
    // Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ Ø¨Ù‡ API: Ù…Ø§ ÙÙ‚Ø· Ø¢Ø®Ø±ÛŒÙ† N Ù¾ÛŒØ§Ù… Ø±Ø§ Ù…ÛŒâ€ŒÙØ±Ø³ØªÛŒÙ… ØªØ§ Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù†ØªØ±Ù„ Ø´ÙˆØ¯
    const historyLimit = 8;
    const chatMessages = messages.slice(-historyLimit).map(m=> ({ role: m.role === 'user' ? 'user' : 'assistant', content: m.content }) );
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… ØªØ§Ø²Ù‡
    chatMessages.push({ role: 'user', content: text });

    const resp = await fetch("https://api.gapgpt.app/v1/chat/completions", {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${GAP_TOKEN}` },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: chatMessages,
        max_tokens: 300
      })
    });
    const json = await resp.json();
    const reply = json?.choices?.[0]?.message?.content || (lang==='fa'?'Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.':'No response.');
    await simulateTyping(reply);
  }catch(e){
    await simulateTyping(lang==='fa'?'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± ÛŒØ§ ØªÙˆÚ©Ù†.':'Server/token error.');
  }finally{
    isTyping = false;
    typingIndicator.style.display = 'none';
    sendBtn.disabled = false;
    sendBtn.textContent = (lang==='fa'?'Ø§Ø±Ø³Ø§Ù„':'Send');
  }
}

/* =================== Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØ§ÛŒÙ¾ (Ø¸Ø§Ù‡Ø± Ø§Ù†Ø³Ø§Ù†ÛŒ) =================== */
function simulateTyping(text){
  return new Promise(resolve=>{
    messages.push({role:'assistant', content:'', time: nowTimeStr()});
    renderMessages();
    let i = 0;
    typingIndicator.style.display = 'block';
    typingInterval = setInterval(()=>{
      if(stopTyping || i >= text.length){
        clearInterval(typingInterval);
        typingIndicator.style.display = 'none';
        stopTyping = false;
        renderMessages();
        resolve();
        return;
      }
      messages[messages.length-1].content += text[i++];
      renderMessages();
    }, 22 + Math.floor(Math.random()*30)); // Ø³Ø±Ø¹Øª Ù†ÙˆØ´ØªÙ† Ø§Ù†Ø¯Ú©ÛŒ ØªØµØ§Ø¯ÙÛŒ
  });
}

/* =================== UI: Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ù†Ø¬Ø±Ù‡ =================== */
function toggleChat(){ if(chatContainer.style.display==='flex'){ closeChat(); } else openChat(); }
function openChat(){ chatContainer.style.display='flex'; chatToggleBtn.style.display='none'; chatContainer.setAttribute('aria-hidden','false'); }
function closeChat(){ chatContainer.style.display='none'; chatToggleBtn.style.display='flex'; chatContainer.setAttribute('aria-hidden','true'); }
function callCreator(){ window.location.href = 'tel:09211243320'; }

/* =================== helpers debug / reset (Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡â€Œ) =================== */
window._bk_reset_restrict = ()=>{ localStorage.removeItem('bk_restrict'); sessionStorage.removeItem('bk_short_block'); sessionStorage.removeItem('bk_msg_log'); alert('reset done'); };

/* =================== Ù¾Ø§ÛŒØ§Ù† =================== */
</script>
</body>
</html>
