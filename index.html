<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BK-AI Chat Multilingual</title>
  <style>
    body {margin:0;font-family:'Vazir','Segoe UI',sans-serif;background:#f9fafb;}
    .chat-toggle-btn{position:fixed;bottom:20px;right:20px;width:70px;height:70px;background-color:#8b5cf6;border:none;border-radius:50%;cursor:pointer;z-index:1001;display:flex;align-items:center;justify-content:center;overflow:visible;box-shadow:0 8px 20px rgba(139,92,246,0.4);transition:all 0.4s ease;}
    .chat-toggle-btn:hover{background-color:#22c55e;}
    .chat-toggle-btn img{width:40px;height:40px;position:absolute;transition:transform 0.3s ease;}
    #botIconNormal{filter:brightness(100%) grayscale(100%);}
    #botIconActive{display:none;filter:brightness(0%) grayscale(100%) invert(100%);}
    .chat-toggle-btn:hover #botIconNormal{transform:scale(1.2);filter:brightness(0%) grayscale(100%) invert(100%);}
    .chat-toggle-btn.active{background-color:#22c55e;}
    .chat-toggle-btn.active #botIconNormal{display:none;}
    .chat-toggle-btn.active #botIconActive{display:block;}
    .pulse-circle{position:absolute;border-radius:50%;background-color:rgba(34,197,94,0.3);z-index:-1;animation:pulse 2s infinite ease-in-out;}
    .circle1{width:80px;height:80px;}
    .circle2{width:100px;height:100px;animation-delay:1s;}
    @keyframes pulse{0%{transform:scale(0.9);opacity:0.7;}50%{transform:scale(1.1);opacity:0.3;}100%{transform:scale(0.9);opacity:0.7;}}
    #chatContainer{display:none;position:fixed;bottom:90px;right:20px;width:400px;height:600px;background:white;border-radius:20px;box-shadow:0 0 25px rgba(0,0,0,0.15);overflow:hidden;z-index:1000;flex-direction:column;transition:all 0.4s ease;}
    @media(max-width:768px){#chatContainer{width:100%;height:100%;bottom:0;right:0;border-radius:0;}}
    .chat-header{background:linear-gradient(90deg,#3b82f6,#8b5cf6);color:white;padding:1rem;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:1rem;box-shadow:0 4px 10px rgba(0,0,0,0.15);position:relative;}
    .chat-header .chat-title{display:flex;align-items:center;gap:10px;}
    .chat-header img{width:30px;height:30px;border-radius:50%;background:white;padding:4px;}
    .header-btns{display:flex;align-items:center;gap:10px;}
    .header-btn{background:rgba(255,255,255,0.15);border:none;color:white;font-size:1.2rem;border-radius:50%;width:36px;height:36px;cursor:pointer;transition:all 0.3s ease;position:relative;overflow:visible;}
    .header-btn:hover{background:rgba(255,255,255,0.35);transform:scale(1.15);}
    .header-btn .tooltip{position:absolute;top:50%;right:120%;transform:translateY(-50%);background:rgba(17,24,39,0.9);color:white;padding:5px 10px;border-radius:6px;font-size:0.8rem;white-space:nowrap;opacity:0;transition:all 0.3s ease;pointer-events:none;}
    .header-btn:hover .tooltip{right:140%;opacity:1;}
    .chat-box{flex:1;overflow-y:auto;padding:1rem;background:#f9fafb;}
    .message{margin-bottom:1rem;padding:0.6rem 0.8rem;border-radius:12px;max-width:80%;line-height:1.6;white-space:pre-wrap;position:relative;}
    .user{background:#dbeafe;margin-left:auto;}
    .assistant{background:#f3f4f6;margin-right:auto;}
    .msg-time{display:block;text-align:right;font-size:0.75rem;color:#9ca3af;margin-top:4px;}
    .user .msg-time{text-align:left;}
    .input-area{display:flex;padding:0.8rem;gap:0.5rem;border-top:1px solid #ddd;background:#fff;}
    input[type="text"]{flex:1;padding:0.6rem;font-size:1rem;border-radius:8px;border:1px solid #ccc;}
    button.send-btn{background:#3b82f6;color:white;border:none;border-radius:8px;padding:0.6rem 1rem;font-size:1rem;cursor:pointer;transition:all 0.2s ease;}
    button.send-btn:hover{background:#2563eb;}
    .typing{font-style:italic;color:#6b7280;padding:0.5rem 1rem;display:none;}
  </style>
</head>
<body>
<button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChat()">
  <div class="pulse-circle circle1"></div>
  <div class="pulse-circle circle2"></div>
  <img id="botIconNormal" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="ربات سفید"/>
  <img id="botIconActive" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="ربات فعال"/>
</button>

<div id="chatContainer">
  <div class="chat-header">
    <div class="chat-title"><img src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="bot"/><span>BK Assistant</span></div>
    <div class="header-btns">
      <button class="header-btn" onclick="callCreator()">📞<span class="tooltip">تماس با سازنده</span></button>
      <button class="header-btn" onclick="closeChat()">✕</button>
    </div>
  </div>
  <div class="chat-box" id="chatBox"></div>
  <div class="typing" id="typingIndicator">در حال نوشتن...</div>
  <div class="input-area">
    <input type="text" id="userInput" placeholder="...پیام خود را بنویسید"/>
    <button class="send-btn" onclick="sendMessage()">ارسال</button>
  </div>
</div>

<script>
const chatBox=document.getElementById('chatBox');
const userInput=document.getElementById('userInput');
const typingIndicator=document.getElementById('typingIndicator');
const sendBtn=document.querySelector('.send-btn');
const chatContainer=document.getElementById('chatContainer');
const chatToggleBtn=document.getElementById('chatToggleBtn');

let messages=[];
let typingInterval=null;
let stopTyping=false;
let jsonData=null;

// تشخیص زبان کاربر (ابتدایی)
function detectLang(text){
  const arabic=/[\u0600-\u06FF]/;
  return arabic.test(text)?'fa':'en';
}

// بارگذاری JSON
async function loadJSON(){
  try{
    const res=await fetch('https://raw.githubusercontent.com/mahdiklidari190/AI-PRO/main/data.json');
    jsonData=await res.json();
  }catch(e){
    console.error("خطا در بارگذاری JSON:",e);
    jsonData=null;
  }
}
loadJSON();

function isMobile(){return window.innerWidth<=768;}
function toggleChat(){chatContainer.style.display==='flex'?closeChat():openChat();}
function openChat(){chatContainer.style.display='flex';chatToggleBtn.classList.add('active');if(isMobile()){chatToggleBtn.style.visibility='hidden';chatToggleBtn.style.opacity='0';}}
function closeChat(){chatContainer.style.display='none';chatToggleBtn.classList.remove('active');if(isMobile()){chatToggleBtn.style.visibility='visible';chatToggleBtn.style.opacity='1';}}
function renderMessages(){chatBox.innerHTML='';messages.forEach(msg=>{const div=document.createElement("div");div.className="message "+(msg.role==="user"?"user":"assistant");div.innerHTML=`${msg.content}<span class="msg-time">${msg.time||""}</span>`;chatBox.appendChild(div);});chatBox.scrollTop=chatBox.scrollHeight;}
const stopMessage=()=>{stopTyping=true;};
function callCreator(){window.location.href="tel:09211243320";}
userInput.addEventListener("keydown",function(e){if(e.key==="Enter"){e.preventDefault();sendMessage();}});

// ترجمه پاسخ JSON به زبان کاربر
async function translateText(text,targetLang){
  if(targetLang==='fa') return text;
  try{
    const res=await fetch("https://api.gapgpt.app/v1/chat/completions",{
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer sk-qCiRXcAOS9sJKtxq7O3tKj8PUf32wzjTAXE8R1wTLEKD4PPa"},
      body:JSON.stringify({
        model:"gpt-4o",
        messages:[
          {role:"system",content:`You are a marketing assistant. Translate the following text to ${targetLang} while keeping marketing tone.`},
          {role:"user",content:text}
        ]
      })
    });
    const data=await res.json();
    return data.choices[0].message.content;
  }catch(e){return text;}
}

// جستجو در JSON
function searchJSON(query){
  if(!jsonData) return null;
  // بررسی company و pages
  const companyKeys=['company','meta','pages'];
  for(const page of jsonData.pages){
    const contentKeys=['title','summary','content_snippet'];
    for(const key of contentKeys){
      if(page[key] && query.toLowerCase().includes(page[key].toLowerCase())) return page.summary||page.content_snippet||page.title;
    }
    // بررسی items یا products
    if(page.items){
      for(const item of page.items){
        if(query.toLowerCase().includes(item.title.toLowerCase())) return item.title+" — برای جزئیات بیشتر به "+item.url+" مراجعه کنید.";
      }
    }
    if(page.products){
      for(const prod of page.products){
        if(query.toLowerCase().includes(prod.title.toLowerCase())) return prod.title+" — برای جزئیات بیشتر به "+prod.url+" مراجعه کنید.";
      }
    }
  }
  // بررسی company fields
  if(jsonData.company){
    if(query.toLowerCase().includes(jsonData.company.name.toLowerCase())) return jsonData.company.name+" — شماره تماس: "+jsonData.company.phones.join(', ');
  }
  return null;
}

// ارسال پیام
async function sendMessage(){
  const content=userInput.value.trim();
  if(!content) return;
  const lang=detectLang(content);
  const timeStr=new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
  messages.push({role:"user",content,time:timeStr});
  renderMessages();
  userInput.value="";
  typingIndicator.style.display='block';
  sendBtn.textContent='توقف';
  sendBtn.onclick=stopMessage;
  stopTyping=false;

  // بررسی JSON
  let reply=searchJSON(content);
  if(reply){
    reply=await translateText(reply,lang);
    await simulateTyping(reply);
    return;
  }

  // بررسی محدودیت
  const forbiddenWords=["کدنویسی","برنامه‌نویسی","code","script","hack","crack"];
  if(forbiddenWords.some(w=>content.toLowerCase().includes(w.toLowerCase()))){
    await simulateTyping("متاسفم، نمی‌توانم این درخواست را انجام دهم چون محدود به چت بازاریابی شرکت هستم.");
    return;
  }

  // API Chat برای مکالمه معمولی
  try{
    const response=await fetch("https://api.gapgpt.app/v1/chat/completions",{
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer sk-qCiRXcAOS9sJKtxq7O3tKj8PUf32wzjTAXE8R1wTLEKD4PPa"},
      body:JSON.stringify({model:"gpt-4o",messages:messages.map(({role,content})=>({role,content}))})
    });
    const data=await response.json();
    reply=data.choices[0].message.content;
    await simulateTyping(reply);
  }catch(err){
    await simulateTyping("متاسفم، مشکلی پیش آمده و پاسخ دریافت نشد.");
  }
}

// تایپ انیمیشنی
async function simulateTyping(text){
  messages.push({role:"assistant",content:"",time:new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})});
  renderMessages();
  let i=0;
  return new Promise(resolve=>{
    typingInterval
