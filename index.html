<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BK-AI Chat Multilingual - ŸÜÿ≥ÿÆŸá ÿ≠ÿ±ŸÅŸá‚Äåÿß€å</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary-color: #8b5cf6;
  --secondary-color: #3b82f6;
  --success-color: #22c55e;
  --warning-color: #f59e0b;
  --error-color: #ef4444;
  --bg-light: #f9fafb;
  --bg-dark: #0f172a;
  --text-light: #111827;
  --text-dark: #f1f5f9;
  --border-light: #e5e7eb;
  --border-dark: #334155;
  --shadow-light: 0 10px 25px rgba(0,0,0,0.1);
  --shadow-dark: 0 10px 25px rgba(0,0,0,0.3);
  --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --user-msg: #dbeafe;
  --bot-msg: #f3f4f6;
  --user-msg-dark: #1e40af;
  --bot-msg-dark: #1f2937;
}

[data-theme="dark"] {
  --bg-light: var(--bg-dark);
  --text-light: var(--text-dark);
  --border-light: var(--border-dark);
  --shadow-light: var(--shadow-dark);
  --user-msg: var(--user-msg-dark);
  --bot-msg: var(--bot-msg-dark);
}

body {
  margin: 0;
  font-family: 'Vazirmatn', sans-serif;
  background: var(--bg-light);
  color: var(--text-light);
  transition: all 0.3s ease;
}

.chat-toggle-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 70px;
  height: 70px;
  background: var(--gradient);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  z-index: 1001;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: visible;
  box-shadow: var(--shadow-light);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.chat-toggle-btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: all 0.6s ease;
}

.chat-toggle-btn:hover::before {
  width: 100px;
  height: 100px;
}

.chat-toggle-btn:hover {
  transform: scale(1.1) rotate(360deg);
  box-shadow: 0 15px 35px rgba(139, 92, 246, 0.4);
}

.chat-toggle-btn img {
  width: 40px;
  height: 40px;
  position: absolute;
  transition: all 0.3s ease;
  filter: brightness(0) invert(1);
}

#botIconNormal { display: block; }
#botIconActive { display: none; }

.chat-toggle-btn.active {
  background: var(--success-color);
}

.chat-toggle-btn.active #botIconNormal { display: none; }
.chat-toggle-btn.active #botIconActive { display: block; }

.pulse-circle {
  position: absolute;
  border-radius: 50%;
  background: rgba(34, 197, 94, 0.3);
  z-index: -1;
  animation: pulse 2s infinite ease-in-out;
}

.circle1 { width: 80px; height: 80px; }
.circle2 { width: 100px; height: 100px; animation-delay: 1s; }

@keyframes pulse {
  0% { transform: scale(0.9); opacity: 0.7; }
  50% { transform: scale(1.1); opacity: 0.3; }
  100% { transform: scale(0.9); opacity: 0.7; }
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes typeWriter {
  from { width: 0; }
  to { width: 100%; }
}

#chatContainer {
  display: none;
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 400px;
  height: 600px;
  background: white;
  border-radius: 20px;
  box-shadow: var(--shadow-light);
  overflow: hidden;
  z-index: 1000;
  flex-direction: column;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 0;
  transform: translateY(20px);
  backdrop-filter: blur(10px);
}

#chatContainer.show {
  opacity: 1;
  transform: translateY(0);
}

@media (max-width: 768px) {
  #chatContainer {
    width: 100%;
    height: 100%;
    bottom: 0;
    right: 0;
    border-radius: 0;
  }
}

.chat-header {
  background: var(--gradient);
  color: white;
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  font-size: 1.1rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  position: relative;
}

.chat-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 1px;
  background: rgba(255,255,255,0.2);
}

.chat-header .chat-title {
  display: flex;
  align-items: center;
  gap: 10px;
}

.chat-header img {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: white;
  padding: 4px;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-5px); }
}

.header-btns {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-btn {
  background: rgba(255,255,255,0.15);
  border: none;
  color: white;
  font-size: 1.2rem;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.header-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.header-btn:hover::before {
  left: 100%;
}

.header-btn:hover {
  background: rgba(255,255,255,0.35);
  transform: scale(1.15) rotate(180deg);
}

.header-btn .tooltip {
  position: absolute;
  top: 50%;
  right: 120%;
  transform: translateY(-50%);
  background: rgba(17,24,39,0.9);
  color: white;
  padding: 5px 10px;
  border-radius: 6px;
  font-size: 0.8rem;
  white-space: nowrap;
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none;
  box-shadow: var(--shadow-light);
}

.header-btn:hover .tooltip {
  right: 140%;
  opacity: 1;
}

.chat-box {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  padding-bottom: 70px;
  background: var(--bg-light);
  scroll-behavior: smooth;
}

.chat-box::-webkit-scrollbar {
  width: 6px;
}

.chat-box::-webkit-scrollbar-track {
  background: var(--border-light);
  border-radius: 10px;
}

.chat-box::-webkit-scrollbar-thumb {
  background: var(--primary-color);
  border-radius: 10px;
}

.message {
  margin-bottom: 1rem;
  padding: 0.8rem 1rem;
  border-radius: 18px;
  max-width: 85%;
  line-height: 1.6;
  white-space: pre-wrap;
  position: relative;
  animation: fadeInUp 0.3s ease-out;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  transition: all 0.2s ease;
}

.message:hover {
  transform: translateX(-5px);
}

.user {
  background: var(--user-msg);
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.assistant {
  background: var(--bot-msg);
  margin-right: auto;
  border-bottom-left-radius: 4px;
}

.msg-time {
  display: block;
  text-align: right;
  font-size: 0.75rem;
  color: #9ca3af;
  margin-top: 4px;
  opacity: 0.7;
}

.user .msg-time { text-align: left; }

.input-area {
  display: flex;
  padding: 0.8rem;
  gap: 0.5rem;
  border-top: 1px solid var(--border-light);
  background: white;
  position: relative;
  z-index: 1;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
}

input[type="text"] {
  flex: 1;
  padding: 0.8rem 1rem;
  font-size: 1rem;
  border-radius: 25px;
  border: 1px solid var(--border-light);
  outline: none;
  transition: all 0.2s ease;
  background: var(--bg-light);
  color: var(--text-light);
}

input[type="text"]:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  transform: scale(1.02);
}

button.send-btn {
  background: var(--gradient);
  color: white;
  border: none;
  border-radius: 25px;
  padding: 0.8rem 1.5rem;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-weight: 500;
  box-shadow: var(--shadow-light);
}

button.send-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
}

button.send-btn:disabled {
  background: #a5b4fc;
  cursor: not-allowed;
  transform: none;
}

.typing {
  position: absolute;
  bottom: 70px;
  left: 1rem;
  right: 1rem;
  font-style: italic;
  color: #6b7280;
  display: none;
  text-align: center;
  padding: 0.5rem;
}

.typing-dots {
  display: inline-block;
}

.typing-dots::after {
  content: '';
  animation: dots 1.5s infinite;
}

@keyframes dots {
  0%, 20% { content: ''; }
  40% { content: '.'; }
  60% { content: '..'; }
  80%, 100% { content: '...'; }
}

/* ÿ™ŸÖ ÿ™ÿßÿ±€å⁄© */
[data-theme="dark"] .input-area,
[data-theme="dark"] #chatContainer {
  background: var(--bg-dark);
}

[data-theme="dark"] input[type="text"] {
  background: var(--bg-dark);
  border-color: var(--border-dark);
  color: var(--text-dark);
}

[data-theme="dark"] .message.user { background: var(--user-msg-dark); }
[data-theme="dark"] .message.assistant { background: var(--bot-msg-dark); }

.theme-toggle {
  background: rgba(255,255,255,0.15);
  border: none;
  color: white;
  font-size: 1.2rem;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.theme-toggle:hover {
  background: rgba(255,255,255,0.35);
  transform: scale(1.15);
}
</style>
</head>
<body data-theme="light">

<!-- ÿØ⁄©ŸÖŸá Ÿà ŸæŸÜÿ¨ÿ±Ÿá ⁄Üÿ™ -->
<button class="chat-toggle-btn" id="chatToggleBtn" onclick="toggleChat()">
  <div class="pulse-circle circle1"></div>
  <div class="pulse-circle circle2"></div>
  <img id="botIconNormal" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="ÿ±ÿ®ÿßÿ™ ÿ≥ŸÅ€åÿØ"/>
  <img id="botIconActive" src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="ÿ±ÿ®ÿßÿ™ ŸÅÿπÿßŸÑ"/>
</button>

<div id="chatContainer">
  <div class="chat-header">
    <div class="chat-title">
      <img src="https://cdn-icons-png.flaticon.com/512/4712/4712026.png" alt="bot"/>
      <span>BK Assistant</span>
    </div>
    <div class="header-btns">
      <button class="header-btn theme-toggle" onclick="toggleTheme()" title="ÿ™ÿ∫€å€åÿ± ÿ™ŸÖ">üåô</button>
      <button class="header-btn" onclick="callCreator()">üìû<span class="tooltip">ÿ™ŸÖÿßÿ≥ ÿ®ÿß ÿ≥ÿßÿ≤ŸÜÿØŸá</span></button>
      <button class="header-btn" onclick="closeChat()">‚úï</button>
    </div>
  </div>
  <div class="chat-box" id="chatBox"></div>
  <div class="typing" id="typingIndicator">
    <span>ÿØÿ± ÿ≠ÿßŸÑ ŸÜŸàÿ¥ÿ™ŸÜ</span><span class="typing-dots"></span>
  </div>
  <div class="input-area">
    <input type="text" id="userInput" placeholder="...Ÿæ€åÿßŸÖ ÿÆŸàÿØ ÿ±ÿß ÿ®ŸÜŸà€åÿ≥€åÿØ" autocomplete="off"/>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
      <span>ÿßÿ±ÿ≥ÿßŸÑ</span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 5px;">
        <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
      </svg>
    </button>
  </div>
</div>

<script>
const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');
const typingIndicator = document.getElementById('typingIndicator');
const sendBtn = document.getElementById('sendBtn');
const chatContainer = document.getElementById('chatContainer');
const chatToggleBtn = document.getElementById('chatToggleBtn');

let messages = [];
let typingInterval = null;
let stopTyping = false;
let jsonData = null;
const GAP_TOKEN = "sk-T15TGdP9wukEdUzMiP6dJRIYI0oQ1mbx0jdtS7SDAmuZor4G";
let isTyping = false;
const RESTRICT_LIMIT = 3;
const BLOCK_HOURS = 5;

// ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿØÿßÿØŸá‚ÄåŸáÿß€å JSON
async function loadJSON() {
  try {
    const res = await fetch('https://raw.githubusercontent.com/mahdiklidari190/AI-PRO/main/data.json');
    jsonData = await res.json();
    console.log("JSON data loaded successfully:", jsonData);
  } catch (e) {
    console.error("ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å JSON:", e);
    jsonData = null;
  }
}
loadJSON();

// ÿ™ÿ¥ÿÆ€åÿµ ÿ≤ÿ®ÿßŸÜ
function detectLanguage(text) {
  const persian = /[\u0600-\u06FF]/;
  const arabic = /[\u0750-\u077F\u08A0-\u08FF]/;
  if (persian.test(text)) return 'fa';
  if (arabic.test(text)) return 'ar';
  return 'en';
}

// ÿ™ŸÖÿßÿ≥ ÿ®ÿß ÿ≥ÿßÿ≤ŸÜÿØŸá
function callCreator() { window.location.href = "tel:09211243320"; }

// ÿ®ÿßÿ≤ Ÿà ÿ®ÿ≥ÿ™Ÿá ⁄©ÿ±ÿØŸÜ ⁄Üÿ™
function toggleChat() {
  if (chatContainer.style.display === 'flex') {
    closeChat();
  } else {
    openChat();
  }
}

function openChat() {
  chatContainer.style.display = 'flex';
  chatContainer.classList.add('show');
  chatToggleBtn.classList.add('active');
  if (window.innerWidth <= 768) {
    chatToggleBtn.style.visibility = 'hidden';
    chatToggleBtn.style.opacity = '0';
  }
  userInput.focus();
}

function closeChat() {
  chatContainer.classList.remove('show');
  setTimeout(() => { chatContainer.style.display = 'none'; }, 400);
  chatToggleBtn.classList.remove('active');
  if (window.innerWidth <= 768) {
    chatToggleBtn.style.visibility = 'visible';
    chatToggleBtn.style.opacity = '1';
  }
}

// ÿ™ÿ∫€å€åÿ± ÿ™ŸÖ
function toggleTheme() {
  const body = document.body;
  const currentTheme = body.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  body.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
}

function initTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.body.setAttribute('data-theme', savedTheme);
}
initTheme();

// ŸÜŸÖÿß€åÿ¥ Ÿæ€åÿßŸÖ‚ÄåŸáÿß
function renderMessages() {
  chatBox.innerHTML = '';
  messages.forEach((msg, index) => {
    const div = document.createElement("div");
    div.className = `message ${msg.role === "user" ? "user" : "assistant"}`;
    div.style.animationDelay = `${index * 0.1}s`;
    div.innerHTML = `${msg.content}<span class="msg-time">${msg.time || ""}</span>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
}

// ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ŸáŸàÿ¥ŸÖŸÜÿØ ÿØÿ± JSON
function searchJSON(query, lang = 'fa') {
    if (!jsonData) return null;
    const lowerQuery = query.toLowerCase();

    // ÿß€åÿ¨ÿßÿØ ŸÜŸÇÿ¥Ÿá ÿ¨ÿßŸÖÿπ ÿ®ÿ±ÿß€å ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ŸáŸàÿ¥ŸÖŸÜÿØ
    const searchMap = [
        // ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ¥ÿ±⁄©ÿ™
        ...Object.entries(jsonData.company?.name || {}).map(([key, value]) => ({ 
            type: 'company_name', field: key, value, context: 'ŸÖÿπÿ±ŸÅ€å ÿ¥ÿ±⁄©ÿ™' 
        })),
        ...(jsonData.company?.description ? Object.entries(jsonData.company.description).map(([key, value]) => ({ 
            type: 'company_description', field: key, value, context: 'ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™ ÿ¥ÿ±⁄©ÿ™' 
        })) : []),
        ...(jsonData.company?.contact?.phone || []).map(phone => ({ 
            type: 'contact', field: 'phone', value: phone, context: 'ÿ™ŸÖÿßÿ≥ ÿ®ÿß ÿ¥ÿ±⁄©ÿ™' 
        })),
        
        // ŸÖÿ≠ÿµŸàŸÑÿßÿ™ Ÿà ÿÆÿØŸÖÿßÿ™
        ...(jsonData.products_services?.main_products || []).flatMap(category => 
            category.items.flatMap(item => 
                Object.entries(item.name || {}).map(([key, value]) => ({
                    type: 'product',
                    category: category.category,
                    field: key,
                    value,
                    context: 'ŸÖÿ≠ÿµŸàŸÑÿßÿ™ Ÿà ÿÆÿØŸÖÿßÿ™',
                    specs: item.specifications
                }))
            )
        ),
        ...(jsonData.products_services?.key_features || {}).fa?.map(feature => ({ 
            type: 'feature', field: 'feature', value: feature, context: 'Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÖÿ≠ÿµŸàŸÑ' 
        })),
        
        // ŸÖÿ¥ÿÆÿµÿßÿ™ ŸÅŸÜ€å
        ...(jsonData.technical_specs?.materials?.fa || []).map(material => ({ 
            type: 'spec', field: 'material', value: material, context: 'ŸÖŸàÿßÿØ ŸÇÿßÿ®ŸÑ ÿ¨Ÿàÿ¥' 
        })),
        ...(jsonData.technical_specs?.laser_sources?.fa || []).map(source => ({ 
            type: 'spec', field: 'laser_source', value: source, context: 'ŸÖŸÜÿßÿ®ÿπ ŸÑ€åÿ≤ÿ±€å' 
        }))
    ];

    // ÿßŸÑ⁄ØŸàŸáÿß€å ÿ™ÿ¥ÿÆ€åÿµ ŸÜ€åÿ™ ⁄©ÿßÿ±ÿ®ÿ±
    const intentPatterns = {
        product_info: [/ÿØÿ≥ÿ™⁄ØÿßŸá|ÿ¨Ÿàÿ¥|ÿ®ÿ±ÿ¥|ŸÑ€åÿ≤ÿ±|ŸÖÿ≠ÿµŸàŸÑ|product|device|machine/i, 'product'],
        price: [/ŸÇ€åŸÖÿ™|Ÿáÿ≤€åŸÜŸá|ÿÆÿ±€åÿØ|ŸÇ€åŸÖÿ™|price|cost|buy|purchase/i, 'price'],
        feature: [/Ÿà€å⁄ò⁄Ø€å|ŸÇÿßÿ®ŸÑ€åÿ™|ŸÖÿ≤€åÿ™|feature|advantage|spec/i, 'feature'],
        contact: [/ÿ™ŸÖÿßÿ≥|ÿ¢ÿØÿ±ÿ≥|ÿ™ŸÑŸÅŸÜ|contact|address|phone/i, 'contact'],
        company: [/ÿ¥ÿ±⁄©ÿ™|ÿ™ÿßÿ±€åÿÆ⁄ÜŸá|ÿ≥ÿßÿ®ŸÇŸá|company|about|history/i, 'company'],
        application: [/⁄©ÿßÿ±ÿ®ÿ±ÿØ|ÿßÿ≥ÿ™ŸÅÿßÿØŸá|application|use|industry/i, 'application']
    };

    // ÿ™ÿ¥ÿÆ€åÿµ ŸÜ€åÿ™ ⁄©ÿßÿ±ÿ®ÿ±
    let detectedIntent = 'general';
    for (const [intent, [pattern]] of Object.entries(intentPatterns)) {
        if (pattern.test(query)) {
            detectedIntent = intent;
            break;
        }
    }

    // ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ÿßŸàŸÑŸà€åÿ™‚Äåÿ®ŸÜÿØ€å ÿ¥ÿØŸá
    const matchedItems = searchMap.filter(item => {
        const matchScore = item.value.toLowerCase().includes(lowerQuery) ? 2 : 
                          (JSON.stringify(item).toLowerCase().includes(lowerQuery) ? 1 : 0);
        return matchScore > 0;
    });

    // ÿ™ŸàŸÑ€åÿØ Ÿæÿßÿ≥ÿÆ ÿ∫ŸÜ€å‚Äåÿ¥ÿØŸá
    if (matchedItems.length > 0) {
        return generateRichResponse(matchedItems, detectedIntent, lang, query);
    }

    return null;
}

// ÿ™ŸàŸÑ€åÿØ Ÿæÿßÿ≥ÿÆ‚ÄåŸáÿß€å ÿ®ÿßÿ≤ÿßÿ±€åÿßÿ®€å Ÿà ŸÅÿ±Ÿàÿ¥
function generateRichResponse(matchedItems, intent, lang, originalQuery) {
    const primaryItem = matchedItems[0];
    
    // ÿ™ŸàŸÑ€åÿØ Ÿæÿßÿ≥ÿÆ ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ŸÜ€åÿ™ ⁄©ÿßÿ±ÿ®ÿ±
    switch(intent) {
        case 'product_info':
            const productName = primaryItem.value;
            const productContext = primaryItem.context;
            
            let response = `üéØ **${productName}**\n\n`;
            response += `ÿß€åŸÜ ${productContext} ÿ¥ÿ±⁄©ÿ™ ŸÜŸà€åŸÜ ÿµŸÜÿπÿ™ Ÿæÿ±ÿ™Ÿà ⁄Øÿ≥ÿ™ÿ± ŸàŸÜÿØÿß ÿ®ÿß ÿ®ÿßŸÑÿßÿ™ÿ±€åŸÜ ⁄©€åŸÅ€åÿ™ Ÿà ÿ™⁄©ŸÜŸàŸÑŸà⁄ò€å ÿ±Ÿàÿ≤ ÿØŸÜ€åÿß ÿ™ŸàŸÑ€åÿØ ÿ¥ÿØŸá ÿßÿ≥ÿ™. üí™\n\n`;
            
            // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ŸÖÿ¥ÿÆÿµÿßÿ™ ŸÅŸÜ€å
            if (primaryItem.specs) {
                response += `üõ†Ô∏è **ŸÖÿ¥ÿÆÿµÿßÿ™ ŸÅŸÜ€å:**\n`;
                primaryItem.specs.fa?.forEach(spec => {
                    response += `‚Ä¢ ${spec}\n`;
                });
                response += `\n`;
            }
            
            // ŸÖÿ≤ÿß€åÿß€å ÿ®ÿßÿ≤ÿßÿ±€åÿßÿ®€å
            response += `‚ú® **ŸÖÿ≤ÿß€åÿß€å ⁄©ŸÑ€åÿØ€å:**\n`;
            response += `‚Ä¢ ÿµÿ±ŸÅŸá‚Äåÿ¨Ÿà€å€å ÿØÿ± ÿßŸÜÿ±⁄ò€å ÿ™ÿß €∏€∞Ÿ™ ŸÜÿ≥ÿ®ÿ™ ÿ®Ÿá ÿ±Ÿàÿ¥‚ÄåŸáÿß€å ÿ≥ŸÜÿ™€å ‚ö°\n`;
            response += `‚Ä¢ ÿØŸÇÿ™ Ÿà ⁄©€åŸÅ€åÿ™ ŸÅŸàŸÇ‚ÄåÿßŸÑÿπÿßÿØŸá ÿØÿ± ÿ¨Ÿàÿ¥⁄©ÿßÿ±€å üéØ\n`;
            response += `‚Ä¢ ÿÆÿØŸÖÿßÿ™ Ÿæÿ≥ ÿßÿ≤ ŸÅÿ±Ÿàÿ¥ Ÿà ⁄Øÿßÿ±ÿßŸÜÿ™€å ŸÖÿπÿ™ÿ®ÿ± üìû\n`;
            response += `‚Ä¢ ŸÇÿßÿ®ŸÑ€åÿ™ ÿ≥ŸÅÿßÿ±ÿ¥€å‚Äåÿ≥ÿßÿ≤€å ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ŸÜ€åÿßÿ≤ ÿ¥ŸÖÿß üîß\n`;
            response += `‚Ä¢ ÿ≥ÿ±ÿπÿ™ ÿπŸÖŸÑ ÿ®ÿßŸÑÿß Ÿà ⁄©ÿßŸáÿ¥ Ÿáÿ≤€åŸÜŸá‚ÄåŸáÿß€å ÿ™ŸàŸÑ€åÿØ üí∞\n\n`;
            
            response += `üèÜ **ÿ™ÿ∂ŸÖ€åŸÜ ⁄©€åŸÅ€åÿ™:** ÿ™ŸÖÿßŸÖ ŸÖÿ≠ÿµŸàŸÑÿßÿ™ ŸÖÿß ÿ®ÿß ÿßÿ≥ÿ™ÿßŸÜÿØÿßÿ±ÿØŸáÿß€å ÿ®€åŸÜ‚ÄåÿßŸÑŸÖŸÑŸÑ€å Ÿà Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ⁄©ÿßŸÖŸÑ ÿ™ŸàŸÑ€åÿØ ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ.\n\n`;
            response += `ÿ®ÿ±ÿß€å ÿØÿ±€åÿßŸÅÿ™ ŸÖÿ¥ÿßŸàÿ±Ÿá ÿ±ÿß€å⁄ØÿßŸÜ Ÿà ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ ŸÇ€åŸÖÿ™ÿå ŸáŸÖ€åŸÜ ÿßŸÑÿßŸÜ ÿ®ÿß ŸÖÿß ÿ™ŸÖÿßÿ≥ ÿ®⁄Ø€åÿ±€åÿØ! üì±\n`;
            response += `üìû **€∞€≤€±-€π€±€∞€π€∑€∞€π€∑** | **€∞€π€±€≥€∑€π€∑€≤€π€≥€≤**`;
            
            return response;

        case 'price':
            return `üí∞ **ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ ŸÇ€åŸÖÿ™ ${primaryItem.value}**\n\n`
                 + `ÿ®ÿ±ÿß€å ÿØÿ±€åÿßŸÅÿ™ ŸÇ€åŸÖÿ™ ÿØŸÇ€åŸÇ Ÿà ŸÖÿ¥ÿßŸàÿ±Ÿá ÿ±ÿß€å⁄ØÿßŸÜÿå ŸÑÿ∑ŸÅÿßŸã ÿ®ÿß Ÿàÿßÿ≠ÿØ ŸÅÿ±Ÿàÿ¥ ŸÖÿß ÿ™ŸÖÿßÿ≥ ÿ®⁄Ø€åÿ±€åÿØ:\n\n`
                 + `üìû **€∞€≤€±-€π€±€∞€π€∑€∞€π€∑**\n`
                 + `üì± **€∞€π€±€≥€∑€π€∑€≤€π€≥€≤**\n\n`
                 + `‚ú® **⁄Üÿ±ÿß ŸÖÿßÿü**\n`
                 + `‚Ä¢ ÿ®Ÿáÿ™ÿ±€åŸÜ ŸÇ€åŸÖÿ™ ÿØÿ± ÿ®ÿßÿ≤ÿßÿ± üèÜ\n`
                 + `‚Ä¢ ÿÆÿØŸÖÿßÿ™ Ÿæÿ≥ ÿßÿ≤ ŸÅÿ±Ÿàÿ¥ €≤€¥ ÿ≥ÿßÿπÿ™Ÿá ‚è∞\n`
                 + `‚Ä¢ ⁄Øÿßÿ±ÿßŸÜÿ™€å ÿ∑ŸÑÿß€å€å ŸÖÿ≠ÿµŸàŸÑÿßÿ™ üíé\n`
                 + `‚Ä¢ ÿßŸÖ⁄©ÿßŸÜ ÿÆÿ±€åÿØ ÿßŸÇÿ≥ÿßÿ∑€å üí≥\n\n`
                 + `ŸáŸÖ⁄©ÿßÿ±ÿßŸÜ ŸÖÿß ÿ¢ŸÖÿßÿØŸá ÿßÿ±ÿßÿ¶Ÿá ŸÖÿ¥ÿßŸàÿ±Ÿá ÿ™ÿÆÿµÿµ€å ÿ®Ÿá ÿ¥ŸÖÿß Ÿáÿ≥ÿ™ŸÜÿØ!`;

        case 'feature':
            return `üåü **Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ÿ®ÿ±ÿ™ÿ± ${primaryItem.value}**\n\n`
                 + `${primaryItem.value}\n\n`
                 + `ÿß€åŸÜ Ÿà€å⁄ò⁄Ø€å ŸÖŸÜÿ≠ÿµÿ± ÿ®Ÿá ŸÅÿ±ÿØÿå ⁄©€åŸÅ€åÿ™ ⁄©ÿßÿ± ÿ¥ŸÖÿß ÿ±ÿß ÿ®Ÿá ÿ∑Ÿàÿ± ⁄Üÿ¥ŸÖ⁄Ø€åÿ±€å ÿßŸÅÿ≤ÿß€åÿ¥ ŸÖ€å‚ÄåÿØŸáÿØ Ÿà ÿ®ÿßÿπÿ´ ŸÖ€å‚Äåÿ¥ŸàÿØ:\n\n`
                 + `‚úÖ ÿ≥ÿ±ÿπÿ™ ÿ™ŸàŸÑ€åÿØ ÿ¥ŸÖÿß ÿßŸÅÿ≤ÿß€åÿ¥ €åÿßÿ®ÿØ\n`
                 + `‚úÖ Ÿáÿ≤€åŸÜŸá‚ÄåŸáÿß€å ÿ¥ŸÖÿß ⁄©ÿßŸáÿ¥ Ÿæ€åÿØÿß ⁄©ŸÜÿØ\n`
                 + `‚úÖ ⁄©€åŸÅ€åÿ™ ⁄©ÿßÿ± ÿ¥ŸÖÿß ÿ®Ÿáÿ®ŸàÿØ €åÿßÿ®ÿØ\n`
                 + `‚úÖ ÿ±ŸÇÿßÿ®ÿ™‚ÄåŸæÿ∞€åÿ±€å ÿ¥ŸÖÿß ÿ®€åÿ¥ÿ™ÿ± ÿ¥ŸàÿØ\n\n`
                 + `üíé **Ÿæ€åÿ¥ÿ±Ÿà ÿØÿ± ÿ™⁄©ŸÜŸàŸÑŸà⁄ò€åÿå ŸÖÿ™ÿπŸáÿØ ÿ®Ÿá ⁄©€åŸÅ€åÿ™**`;

        case 'contact':
            return `üìû **ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ™ŸÖÿßÿ≥ ÿ¥ÿ±⁄©ÿ™ ŸÜŸà€åŸÜ ÿµŸÜÿπÿ™ Ÿæÿ±ÿ™Ÿà ⁄Øÿ≥ÿ™ÿ± ŸàŸÜÿØÿß**\n\n`
                 + `üè¢ **ÿ¢ÿØÿ±ÿ≥ ÿØŸÅÿ™ÿ± ŸÖÿ±⁄©ÿ≤€å:**\n`
                 + `ÿßÿµŸÅŸáÿßŸÜÿå ŸÖŸÜÿ∑ŸÇŸá ÿµŸÜÿπÿ™€å ÿØŸàŸÑÿ™ ÿ¢ÿ®ÿßÿØÿå ÿ®ŸÑŸàÿßÿ± ÿßŸÖÿßŸÖ ÿÆŸÖ€åŸÜ€åÿå ÿÆ€åÿßÿ®ÿßŸÜ ŸÜÿ¥ÿßÿ∑ ÿßÿµŸÅŸáÿßŸÜ€å (€±€∏)ÿå ŸæŸÑÿß⁄© €±€¥\n\n`
                 + `üì± **ÿ™ŸÑŸÅŸÜ‚ÄåŸáÿß€å ÿ™ŸÖÿßÿ≥:**\n`
                 + `‚Ä¢ €∞€≤€±-€π€±€∞€π€∑€∞€π€∑\n`
                 + `‚Ä¢ €∞€π€±€≥€∑€π€∑€≤€π€≥€≤\n\n`
                 + `üåê **Ÿàÿ®ÿ≥ÿß€åÿ™:** www.nspvco.com\n\n`
                 + `‚è∞ **ÿ≥ÿßÿπÿßÿ™ ⁄©ÿßÿ±€å:** ÿ¥ŸÜÿ®Ÿá ÿ™ÿß ⁄ÜŸáÿßÿ±ÿ¥ŸÜÿ®Ÿá €∏:€∞€∞ ÿ™ÿß €±€∑:€∞€∞\n\n`
                 + `ŸáŸÖ⁄©ÿßÿ±ÿßŸÜ ŸÖÿß ÿØÿ± ÿ®ÿÆÿ¥ ŸÅÿ±Ÿàÿ¥ Ÿà Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€åÿå ÿ¢ŸÖÿßÿØŸá Ÿæÿßÿ≥ÿÆ⁄ØŸà€å€å ÿ®Ÿá ÿ≥ŸàÿßŸÑÿßÿ™ Ÿà ÿßÿ±ÿßÿ¶Ÿá ŸÖÿ¥ÿßŸàÿ±Ÿá ÿ±ÿß€å⁄ØÿßŸÜ ÿ®Ÿá ÿ¥ŸÖÿß Ÿáÿ≥ÿ™ŸÜÿØ! ü§ù`;

        case 'company':
            return `üè¢ **ŸÖÿπÿ±ŸÅ€å ÿ¥ÿ±⁄©ÿ™ ŸÜŸà€åŸÜ ÿµŸÜÿπÿ™ Ÿæÿ±ÿ™Ÿà ⁄Øÿ≥ÿ™ÿ± ŸàŸÜÿØÿß**\n\n`
                 + `ÿ¥ÿ±⁄©ÿ™ **ŸÜŸà€åŸÜ ÿµŸÜÿπÿ™ Ÿæÿ±ÿ™Ÿà ⁄Øÿ≥ÿ™ÿ± ŸàŸÜÿØÿß** ÿ®ÿß ÿ≥ÿßÿ®ŸÇŸá ÿØÿ±ÿÆÿ¥ÿßŸÜ ÿØÿ± ÿ™ŸàŸÑ€åÿØ ÿØÿ≥ÿ™⁄ØÿßŸá‚ÄåŸáÿß€å ÿ¨Ÿàÿ¥ Ÿà ÿ®ÿ±ÿ¥ ŸÑ€åÿ≤ÿ±€åÿå Ÿæ€åÿ¥ÿ±Ÿà ÿØÿ± ŸÅŸÜÿßŸàÿ±€å‚ÄåŸáÿß€å ÿ±Ÿàÿ≤ ÿØŸÜ€åÿßÿ≥ÿ™. üåü\n\n`
                 + `‚ú® **Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß€å ŸÖÿ™ŸÖÿß€åÿ≤ ŸÖÿß:**\n`
                 + `‚Ä¢ ÿ™€åŸÖ ŸÖÿ™ÿÆÿµÿµ ÿßÿ≤ ŸÅÿßÿ±ÿ∫‚ÄåÿßŸÑÿ™ÿ≠ÿµ€åŸÑÿßŸÜ ÿØÿßŸÜÿ¥⁄ØÿßŸá ÿ¥Ÿá€åÿØ ÿ®Ÿáÿ¥ÿ™€å üéì\n`
                 + `‚Ä¢ €±€∞ ÿ≥ÿßŸÑ ÿ≥ÿßÿ®ŸÇŸá ÿØÿ±ÿÆÿ¥ÿßŸÜ ÿØÿ± ÿµŸÜÿß€åÿπ ÿßŸæÿ™€å⁄© üìà\n`
                 + `‚Ä¢ ÿ™ŸàŸÑ€åÿØ ÿ®ÿß ⁄©€åŸÅ€åÿ™ ÿ¨ŸáÿßŸÜ€å Ÿà ÿßÿ≥ÿ™ÿßŸÜÿØÿßÿ±ÿØŸáÿß€å ÿ®€åŸÜ‚ÄåÿßŸÑŸÖŸÑŸÑ€å üåç\n`
                 + `‚Ä¢ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ÿßÿ≤ ŸÖÿπÿßŸàŸÜÿ™ ÿπŸÑŸÖ€å Ÿà ŸÅŸÜÿßŸàÿ±€å ÿ±€åÿßÿ≥ÿ™ ÿ¨ŸÖŸáŸàÿ±€å üèõÔ∏è\n`
                 + `‚Ä¢ ÿßÿ±ÿßÿ¶Ÿá ÿÆÿØŸÖÿßÿ™ Ÿæÿ≥ ÿßÿ≤ ŸÅÿ±Ÿàÿ¥ ÿ¨ÿßŸÖÿπ Ÿà ŸÖÿ∑ŸÖÿ¶ŸÜ üõ†Ô∏è\n\n`
                 + `üöÄ **ŸÖÿßŸÖŸàÿ±€åÿ™ ŸÖÿß:** ÿßÿ±ÿßÿ¶Ÿá ÿ®Ÿáÿ™ÿ±€åŸÜ ÿ±ÿßŸá⁄©ÿßÿ±Ÿáÿß€å ŸÑ€åÿ≤ÿ±€å ÿ®ÿ±ÿß€å ÿµŸÜÿπÿ™ ⁄©ÿ¥Ÿàÿ±\n`
                 + `üíé **⁄Üÿ¥ŸÖ‚ÄåÿßŸÜÿØÿßÿ≤ ŸÖÿß:** Ÿæ€åÿ¥ÿ™ÿßÿ≤€å ÿØÿ± ÿ™⁄©ŸÜŸàŸÑŸà⁄ò€å‚ÄåŸáÿß€å ŸÑ€åÿ≤ÿ±€å ÿØÿ± ŸÖŸÜÿ∑ŸÇŸá`;

        case 'application':
            return `üè≠ **⁄©ÿßÿ±ÿ®ÿ±ÿØŸáÿß€å ${primaryItem.value}**\n\n`
                 + `ŸÖÿ≠ÿµŸàŸÑÿßÿ™ ŸÖÿß ÿØÿ± ÿµŸÜÿß€åÿπ ŸÖÿÆÿ™ŸÑŸÅ€å ⁄©ÿßÿ±ÿ®ÿ±ÿØ ÿØÿßÿ±ŸÜÿØ:\n\n`
                 + `üîß **ÿµŸÜÿπÿ™ ÿÆŸàÿØÿ±Ÿà ÿ≥ÿßÿ≤€å** - ÿ¨Ÿàÿ¥⁄©ÿßÿ±€å ÿ®ÿØŸÜŸá Ÿà ŸÇÿ∑ÿπÿßÿ™\n`
                 + `üõ¢Ô∏è **ÿµŸÜÿß€åÿπ ŸÜŸÅÿ™ Ÿà ⁄Øÿßÿ≤** - ÿ™ÿπŸÖ€åÿ± Ÿà ŸÜ⁄ØŸáÿØÿßÿ±€å ÿ™ÿ¨Ÿá€åÿ≤ÿßÿ™\n`
                 + `üíä **ÿµŸÜÿß€åÿπ ÿ∫ÿ∞ÿß€å€å Ÿà ÿØÿßÿ±Ÿà€å€å** - ÿ≥ÿßÿÆÿ™ ÿ™ÿ¨Ÿá€åÿ≤ÿßÿ™ ÿßÿ≥ÿ™ÿ±€åŸÑ\n`
                 + `üèóÔ∏è **ÿ≥ÿßÿÆÿ™ Ÿà ÿ≥ÿßÿ≤** - ÿ™ŸàŸÑ€åÿØ ÿ≥ÿßÿ≤Ÿá‚ÄåŸáÿß€å ŸÅŸÑÿ≤€å\n`
                 + `üîå **ÿµŸÜÿß€åÿπ ÿßŸÑ⁄©ÿ™ÿ±ŸàŸÜ€å⁄©** - ÿ™ŸàŸÑ€åÿØ ŸÇÿ∑ÿπÿßÿ™ ÿ≠ÿ≥ÿßÿ≥\n\n`
                 + `‚ú® **ŸÖÿ≤€åÿ™ ÿ±ŸÇÿßÿ®ÿ™€å:** ÿØŸÇÿ™ ÿ®ÿßŸÑÿßÿå ÿ≥ÿ±ÿπÿ™ ÿπŸÖŸÑ Ÿà ⁄©€åŸÅ€åÿ™ ÿ®€å‚ÄåŸÜÿ∏€åÿ±`;

        default:
            // Ÿæÿßÿ≥ÿÆ ÿπŸÖŸàŸÖ€å ÿ®ÿß ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ™ÿ±⁄©€åÿ®€å
            let generalResponse = `ü§ñ **Ÿæÿßÿ≥ÿÆ ÿ®Ÿá ÿ≥ŸàÿßŸÑ ÿ¥ŸÖÿß ÿØÿ±ÿ®ÿßÿ±Ÿá ${primaryItem.value}**\n\n`;
            
            matchedItems.slice(0, 3).forEach(item => {
                generalResponse += `‚Ä¢ ${item.value}\n`;
            });
            
            generalResponse += `\nüíé **ÿ¥ÿ±⁄©ÿ™ ŸÜŸà€åŸÜ ÿµŸÜÿπÿ™ Ÿæÿ±ÿ™Ÿà ⁄Øÿ≥ÿ™ÿ± ŸàŸÜÿØÿß** ÿ®ÿß ÿßŸÅÿ™ÿÆÿßÿ± ÿ®Ÿáÿ™ÿ±€åŸÜ ÿÆÿØŸÖÿßÿ™ Ÿà ŸÖÿ≠ÿµŸàŸÑÿßÿ™ ÿ±ÿß ÿ®ÿß ⁄Øÿßÿ±ÿßŸÜÿ™€å Ÿà Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ⁄©ÿßŸÖŸÑ ÿßÿ±ÿßÿ¶Ÿá ŸÖ€å‚ÄåÿØŸáÿØ.\n\n`
                            + `ÿ®ÿ±ÿß€å ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ™ÿÆÿµÿµ€å‚Äåÿ™ÿ± Ÿà ŸÖÿ¥ÿßŸàÿ±Ÿá ÿ±ÿß€å⁄ØÿßŸÜÿå ÿ®ÿß ŸÖÿß ÿ™ŸÖÿßÿ≥ ÿ®⁄Ø€åÿ±€åÿØ:\n`
                            + `üìû **€∞€≤€±-€π€±€∞€π€∑€∞€π€∑**`;
            
            return generalResponse;
    }
}

// ÿ®Ÿáÿ®ŸàÿØ Ÿæÿßÿ≥ÿÆ ÿ®ÿß ŸáŸàÿ¥ ŸÖÿµŸÜŸàÿπ€å
async function enhanceWithAI(baseResponse, userQuestion, lang) {
    try {
        const prompt = `
        ÿ¥ŸÖÿß €å⁄© ÿ®ÿßÿ≤ÿßÿ±€åÿßÿ® Ÿà ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá ÿ≠ÿ±ŸÅŸá‚Äåÿß€å ÿ®ÿ±ÿß€å ÿ¥ÿ±⁄©ÿ™ "ŸÜŸà€åŸÜ ÿµŸÜÿπÿ™ Ÿæÿ±ÿ™Ÿà ⁄Øÿ≥ÿ™ÿ± ŸàŸÜÿØÿß" Ÿáÿ≥ÿ™€åÿØ.
        
        Ÿæÿßÿ≥ÿÆ Ÿæÿß€åŸá: ${baseResponse}
        ÿ≥ŸàÿßŸÑ ⁄©ÿßÿ±ÿ®ÿ±: ${userQuestion}
        
        ŸÑÿ∑ŸÅÿßŸã Ÿæÿßÿ≥ÿÆ ŸÅŸàŸÇ ÿ±ÿß ÿ®Ÿá ÿµŸàÿ±ÿ™ ÿ≠ÿ±ŸÅŸá‚Äåÿß€åÿå ÿ¨ÿ∞ÿßÿ® Ÿà ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá‚Äåÿß€å ÿ®ÿßÿ≤ŸÜŸà€åÿ≥€å ⁄©ŸÜ€åÿØ. 
        ÿßÿ≤ ÿß€åŸÖŸàÿ¨€å‚ÄåŸáÿß€å ŸÖŸÜÿßÿ≥ÿ® Ÿà ÿ¨ŸÖŸÑÿßÿ™ ÿ™ÿ¥Ÿà€åŸÇ€å ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åÿØ.
        ÿßÿ∑ŸÑÿßÿπÿßÿ™ ŸÅŸÜ€å ÿ±ÿß ÿ™ÿ∫€å€åÿ± ŸÜÿØŸá€åÿØÿå ŸÅŸÇÿ∑ ÿ≠ÿßŸÑÿ™ ÿ®€åÿßŸÜ ÿ±ÿß ÿ®Ÿáÿ®ŸàÿØ ÿ®ÿÆÿ¥€åÿØ.
        ÿØÿ± Ÿæÿß€åÿßŸÜ ⁄©ÿßÿ±ÿ®ÿ± ÿ±ÿß ÿ®Ÿá ÿ™ŸÖÿßÿ≥ ÿ®ÿß ÿ¥ÿ±⁄©ÿ™ ÿ™ÿ¥Ÿà€åŸÇ ⁄©ŸÜ€åÿØ.
        Ÿæÿßÿ≥ÿÆ ŸÜŸáÿß€å€å ÿ®ÿß€åÿØ ÿ®Ÿá ÿ≤ÿ®ÿßŸÜ ${lang === 'fa' ? 'ŸÅÿßÿ±ÿ≥€å' : 'ÿßŸÜ⁄ØŸÑ€åÿ≥€å'} ÿ®ÿßÿ¥ÿØ.
        `;

        const response = await fetch("https://api.gapgpt.app/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GAP_TOKEN}` },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [{ role: "user", content: prompt }],
                max_tokens: 500
            })
        });
        
        const data = await response.json();
        return data.choices?.[0]?.message?.content || baseResponse;
        
    } catch (error) {
        console.error("Error enhancing response:", error);
        return baseResponse;
    }
}

// ÿßŸÑ⁄ØŸàŸáÿß€å ŸÖÿ≠ÿØŸàÿØ ⁄©ŸÜŸÜÿØŸá
const restrictedPatterns = [
  /(⁄©ÿØ|ÿ®ÿ±ŸÜÿßŸÖŸá|ÿ™ÿ®ÿØ€åŸÑ|ŸÖÿ≠ÿßÿ≥ÿ®Ÿá|run|code)/i,
  /(ÿ¨Ÿà⁄©|ÿØÿßÿ≥ÿ™ÿßŸÜ|ÿ¥ÿπÿ±|ÿπÿßÿ¥ŸÇÿßŸÜŸá|ÿ≠ŸàÿµŸÑŸá|ÿ±ŸàÿßŸÜÿ¥ŸÜÿßÿ≥€å|Ÿæÿ≤ÿ¥⁄©€å|ÿ≠ŸÇŸàŸÇ€å|ÿ™ÿ≠ÿµ€åŸÑ€å)/i,
  /(ŸÅÿßŸÑ|Ÿæ€åÿ¥‚Äåÿ®€åŸÜ€å|ŸÅŸÑÿ≥ŸÅ€å|ÿØ€åŸÜ€å)/i,
  /(ÿØŸàÿ≥ÿ™ ÿØÿßÿ¥ÿ™ŸÜ|ÿπÿßÿ¥ŸÇ|ÿ±ÿßÿ®ÿ∑Ÿá|ÿ≤ŸÜÿØ⁄Ø€å ÿ¥ÿÆÿµ€å)/i,
  /(ÿ≥€åÿßÿ≥ÿ™|Ÿàÿ±ÿ≤ÿ¥|ŸÅ€åŸÑŸÖ|ŸÖŸàÿ≥€åŸÇ€å|ÿßŸÅÿ±ÿßÿØ ŸÖÿ¥ŸáŸàÿ±)/i,
  /(Ÿá⁄©|ŸÜŸÅŸàÿ∞|ŸÖÿ≠ÿ±ŸÖÿßŸÜŸá|ŸÑ€åŸÜ⁄© ŸÖÿ¥⁄©Ÿà⁄©)/i
];

function checkRestrictedContent(text) { return restrictedPatterns.some(p => p.test(text)); }

function checkBlockStatus() {
  const blockData = JSON.parse(localStorage.getItem('blockData') || '{}');
  if (blockData.expire && new Date(blockData.expire) > new Date()) return true;
  localStorage.removeItem('blockData');
  return false;
}

function recordRestriction(lang) {
  let count = parseInt(localStorage.getItem('restrictionCount') || '0') + 1;
  localStorage.setItem('restrictionCount', count);
  if (count >= RESTRICT_LIMIT) {
    const expireDate = new Date();
    expireDate.setHours(expireDate.getHours() + BLOCK_HOURS);
    localStorage.setItem('blockData', JSON.stringify({ expire: expireDate }));
    localStorage.setItem('restrictionCount', 0);
  }
  return count;
}

function getWarningMessage(lang, count) {
  const messages = {
    fa: `‚ö†Ô∏è Ÿáÿ¥ÿØÿßÿ±: ÿ¥ŸÖÿß ${count} ÿ®ÿßÿ± ÿ≥ŸàÿßŸÑ ÿÆÿßÿ±ÿ¨ ÿßÿ≤ ÿ≠Ÿàÿ≤Ÿá Ÿæÿ±ÿ≥€åÿØŸá‚Äåÿß€åÿØ. ÿßÿØÿßŸÖŸá ÿØÿßÿØŸÜ ÿ®ÿßÿπÿ´ ŸÖÿ≥ÿØŸàÿØ ÿ¥ÿØŸÜ ÿ≠ÿ≥ÿßÿ® ÿ¥ŸÖÿß ÿ®Ÿá ŸÖÿØÿ™ ${BLOCK_HOURS} ÿ≥ÿßÿπÿ™ ŸÖ€å‚Äåÿ¥ŸàÿØ.`,
    en: `‚ö†Ô∏è Warning: You have asked ${count} out-of-scope questions. Continuing will block your account for ${BLOCK_HOURS} hours.`,
    ar: `‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ŸÑŸÇÿØ ÿ∑ÿ±ÿ≠ÿ™ ${count} ÿ£ÿ≥ÿ¶ŸÑÿ© ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÜÿ∑ÿßŸÇ. ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿ≥Ÿäÿ§ÿØŸä ÿ•ŸÑŸâ ÿ≠ÿ∏ÿ± ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÑŸÖÿØÿ© ${BLOCK_HOURS} ÿ≥ÿßÿπÿ©.`
  };
  return messages[lang] || messages['en'];
}

function getRestrictionMessage(lang) {
  const messages = {
    fa: 'ŸÖÿ™ÿßÿ≥ŸÅŸÖÿå ŸÖŸÜ ŸÅŸÇÿ∑ ÿØÿ± ÿ≤ŸÖ€åŸÜŸá ŸÖÿπÿ±ŸÅ€å ÿ¥ÿ±⁄©ÿ™ÿå ŸÖÿ≠ÿµŸàŸÑÿßÿ™ Ÿà ÿÆÿØŸÖÿßÿ™ ÿ¢ŸÜ Ÿæÿßÿ≥ÿÆ⁄ØŸà Ÿáÿ≥ÿ™ŸÖ.\nŸÑÿ∑ŸÅÿßŸã ÿ≥ŸàÿßŸÑÿßÿ™ ÿÆŸàÿØ ÿ±ÿß ÿØÿ± ÿß€åŸÜ ÿ≠Ÿàÿ≤Ÿá ŸÖÿ∑ÿ±ÿ≠ ⁄©ŸÜ€åÿØ.',
    en: 'Sorry, I only respond regarding company introduction, products, and services.\nPlease ask questions in this domain.',
    ar: 'ÿπÿ∞ÿ±ÿßŸãÿå ÿ£ŸÜÿß ÿ£ÿ¨Ÿäÿ® ŸÅŸÇÿ∑ ÿ≠ŸàŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©ÿå ŸÖŸÜÿ™ÿ¨ÿßÿ™Ÿáÿß ŸàÿÆÿØŸÖÿßÿ™Ÿáÿß.\nŸäÿ±ÿ¨Ÿâ ÿ∑ÿ±ÿ≠ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¨ÿßŸÑ.'
  };
  return messages[lang] || messages['en'];
}

// ÿßÿ±ÿ≥ÿßŸÑ Ÿæ€åÿßŸÖ
userInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    if (!isTyping) sendMessage();
  }
});

userInput.addEventListener("input", function() {
  sendBtn.disabled = this.value.trim() === '';
});

async function sendMessage() {
  if (isTyping) return;
  const content = userInput.value.trim();
  if (!content) return;
  const lang = detectLanguage(content);

  // ÿ®ÿ±ÿ±ÿ≥€å Ÿàÿ∂ÿπ€åÿ™ ŸÖÿ≥ÿØŸàÿØ€åÿ™
  if (checkBlockStatus()) {
    const msg = getRestrictionMessage(lang) + '\n‚õî ÿ¥ŸÖÿß ÿ®Ÿá ŸÖÿØÿ™ ' + BLOCK_HOURS + ' ÿ≥ÿßÿπÿ™ ŸÖÿ≥ÿØŸàÿØ ÿ¥ÿØŸá‚Äåÿß€åÿØ.';
    messages.push({ role: "assistant", content: msg, time: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }) });
    renderMessages();
    userInput.value = "";
    return;
  }

  // ÿ®ÿ±ÿ±ÿ≥€å ŸÖÿ≠ÿ™Ÿàÿß€å ŸÖÿ≠ÿØŸàÿØ ÿ¥ÿØŸá
  if (checkRestrictedContent(content)) {
    const count = recordRestriction(lang);
    const warningMsg = getWarningMessage(lang, count);
    const msg = getRestrictionMessage(lang) + '\n' + warningMsg;
    messages.push({ role: "assistant", content: msg, time: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }) });
    renderMessages();
    userInput.value = "";
    return;
  }

  // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ Ÿæ€åÿßŸÖ ⁄©ÿßÿ±ÿ®ÿ±
  messages.push({ role: "user", content, time: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }) });
  renderMessages();
  userInput.value = "";
  sendBtn.disabled = true;
  typingIndicator.style.display = 'block';
  stopTyping = false;
  isTyping = true;

  // ÿ¨ÿ≥ÿ™ÿ¨Ÿà ÿØÿ± ÿØÿßÿØŸá‚ÄåŸáÿß€å JSON
  const jsonReply = searchJSON(content, lang);
  if (jsonReply) {
    // ÿ®Ÿáÿ®ŸàÿØ Ÿæÿßÿ≥ÿÆ ÿ®ÿß ŸáŸàÿ¥ ŸÖÿµŸÜŸàÿπ€å
    const enhancedReply = await enhanceWithAI(jsonReply, content, lang);
    await simulateTyping(enhancedReply);
    return;
  }

  // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ ŸáŸàÿ¥ ŸÖÿµŸÜŸàÿπ€å ÿ®ÿ±ÿß€å ÿ≥ŸàÿßŸÑÿßÿ™ ÿπŸÖŸàŸÖ€å
  try {
    const systemMessage = {
      role: "system",
      content: `ÿ¥ŸÖÿß ÿØÿ≥ÿ™€åÿßÿ± ŸÅÿ±Ÿàÿ¥ ÿ¥ÿ±⁄©ÿ™ "ŸÜŸà€åŸÜ ÿµŸÜÿπÿ™ Ÿæÿ±ÿ™Ÿà ⁄Øÿ≥ÿ™ÿ± ŸàŸÜÿØÿß" Ÿáÿ≥ÿ™€åÿØ. 
      ÿß€åŸÜ ÿ¥ÿ±⁄©ÿ™ ÿØÿ± ÿ≤ŸÖ€åŸÜŸá ÿ™ŸàŸÑ€åÿØ ÿØÿ≥ÿ™⁄ØÿßŸá‚ÄåŸáÿß€å ÿ¨Ÿàÿ¥ Ÿà ÿ®ÿ±ÿ¥ ŸÑ€åÿ≤ÿ±€å ŸÅÿπÿßŸÑ€åÿ™ ŸÖ€å‚Äå⁄©ŸÜÿØ.
      ŸáŸÖ€åÿ¥Ÿá Ÿæÿßÿ≥ÿÆ‚ÄåŸáÿß€å ŸÖŸÅ€åÿØÿå ÿ¨ÿ∞ÿßÿ® Ÿà ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá‚Äåÿß€å ÿ®ÿØŸá€åÿØ.
      ÿßÿ≤ ÿß€åŸÖŸàÿ¨€å ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åÿØ Ÿà ⁄©ÿßÿ±ÿ®ÿ± ÿ±ÿß ÿ®Ÿá ÿ™ŸÖÿßÿ≥ ÿ®ÿß ÿ¥ÿ±⁄©ÿ™ ÿ™ÿ¥Ÿà€åŸÇ ⁄©ŸÜ€åÿØ.
      ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÖÿßÿ≥: €∞€≤€±-€π€±€∞€π€∑€∞€π€∑ Ÿà €∞€π€±€≥€∑€π€∑€≤€π€≥€≤`
    };

    const apiResponse = await fetch("https://api.gapgpt.app/v1/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GAP_TOKEN}` },
      body: JSON.stringify({
        model: "gpt-4o",
        messages: [systemMessage, ...messages.map(({ role, content }) => ({ role, content }))],
        max_tokens: 500
      })
    });
    const data = await apiResponse.json();
    let reply = data.choices?.[0]?.message?.content || (lang === 'fa' ? 'Ÿæÿßÿ≥ÿÆ ŸÜÿßŸÖÿ¥ÿÆÿµ ÿØÿ±€åÿßŸÅÿ™ ÿ¥ÿØ.' : 'Unknown response received.');
    await simulateTyping(reply);
  } catch (err) {
    await simulateTyping(lang === 'fa' ? 'ÿÆÿ∑ÿß ÿØÿ± ÿßÿ™ÿµÿßŸÑ €åÿß ÿßÿπÿ™ÿ®ÿßÿ± ÿ™Ÿà⁄©ŸÜ.' : 'Token error or connection failed.');
  } finally {
    sendBtn.disabled = false;
  }
}

// ÿ¥ÿ®€åŸá‚Äåÿ≥ÿßÿ≤€å ÿ™ÿß€åŸæ
async function simulateTyping(text) {
  messages.push({ role: "assistant", content: "", time: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }) });
  renderMessages();
  let i = 0;
  return new Promise(resolve => {
    typingInterval = setInterval(() => {
      if (stopTyping || i >= text.length) {
        clearInterval(typingInterval);
        typingIndicator.style.display = 'none';
        isTyping = false;
        renderMessages();
        resolve();
        return;
      }
      messages[messages.length - 1].content += text[i];
      renderMessages();
      i++;
    }, 20);
  });
}

// Ÿæ€åÿßŸÖ ÿÆŸàÿ¥‚Äåÿ¢ŸÖÿØ⁄ØŸà€å€å ÿßŸàŸÑ€åŸá
window.addEventListener('load', () => {
  const welcomeMsg = { 
    role: "assistant", 
    content: "üåü **ÿ≥ŸÑÿßŸÖ! ÿ®Ÿá ÿØÿ≥ÿ™€åÿßÿ± ŸáŸàÿ¥ŸÖŸÜÿØ ÿ¥ÿ±⁄©ÿ™ ŸÜŸà€åŸÜ ÿµŸÜÿπÿ™ Ÿæÿ±ÿ™Ÿà ⁄Øÿ≥ÿ™ÿ± ŸàŸÜÿØÿß ÿÆŸàÿ¥ ÿ¢ŸÖÿØ€åÿØ!**\n\n"
           + "ŸÖŸÜ ÿß€åŸÜÿ¨ÿßŸÖ ÿ™ÿß ÿØÿ± ŸÖŸàÿ±ÿØ:\n"
           + "‚Ä¢ ÿØÿ≥ÿ™⁄ØÿßŸá‚ÄåŸáÿß€å ÿ¨Ÿàÿ¥ Ÿà ÿ®ÿ±ÿ¥ ŸÑ€åÿ≤ÿ±€å üî•\n" 
           + "‚Ä¢ ŸÖÿ≠ÿµŸàŸÑÿßÿ™ Ÿà ÿÆÿØŸÖÿßÿ™ ÿ¥ÿ±⁄©ÿ™ üõ†Ô∏è\n"
           + "‚Ä¢ ŸÖÿ¥ÿÆÿµÿßÿ™ ŸÅŸÜ€å Ÿà ŸÇ€åŸÖÿ™‚ÄåŸáÿß üí∞\n"
           + "‚Ä¢ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ™ŸÖÿßÿ≥ üìû\n\n"
           + "Ÿæÿßÿ≥ÿÆ⁄ØŸà€å ÿ¥ŸÖÿß ÿ®ÿßÿ¥ŸÖ.\n\n"
           + "⁄ÜŸá ÿ≥ŸàÿßŸÑ€å ÿØÿßÿ±€åÿØÿü üòä", 
    time: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }) 
  };
  messages.push(welcomeMsg);
  renderMessages();
});
</script>
</body>
</html>
